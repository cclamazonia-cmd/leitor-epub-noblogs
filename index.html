<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca</title>

  <!-- epub.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#666666;
      --card:#f5f5f5;
      --border:#dddddd;

      --btnbg:transparent;
      --btnfg:var(--fg);
      --accent:#111111;
      --accentfg:#ffffff;

      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --font-ui:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      --font-reading:ui-serif,"Georgia","Times New Roman",Times,serif;

      /* Catalogue background (fixed, not theme-dependent) */
      --catalog-bg-url:url("https://cclamazonia.noblogs.org/files/2024/11/Arte-CCLA-paredao.jpg");

      /* Reader watermark (very subtle) */
      --reader-wm-url:url("https://cclamazonia.noblogs.org/files/2024/11/Arte-CCLA-paredao.jpg");
    }

    body.night{
      --bg:#0f1115;
      --fg:#e9edf1;
      --muted:#a6b0bb;
      --card:#171a21;
      --border:#262b36;
      --btnbg:transparent;
      --btnfg:var(--fg);
      --accent:#e9edf1;
      --accentfg:#0f1115;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font-ui);
      color:var(--fg);
      background:var(--bg);
    }

    /* ======== Lock screen ======== */
    .lock{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:9999;
    }
    .lock.show{display:flex}
    .lockCard{
      width:min(520px,100%);
      border-radius:20px;
      background:var(--bg);
      color:var(--fg);
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      padding:22px;
    }
    .lockCard h1{
      margin:0 0 10px 0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .lockCard p{
      margin:0 0 14px 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .field{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:13px;
      color:var(--muted);
    }
    input[type="password"], input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--fg);
      outline:none;
      font-size:14px;
    }
    .check{
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      font-size:13px;
      color:var(--muted);
      margin-top:8px;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--btnbg);
      color:var(--btnfg);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accentfg);
    }
    .btn:active{transform:translateY(1px)}
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    .error{
      display:none;
      margin-top:10px;
      font-size:13px;
      color:#b00020;
    }
    body.night .error{color:#ff7b7b}

    /* ======== Catalogue ======== */
    header{
      padding:28px 18px 18px 18px;
      background:
        linear-gradient(to bottom, rgba(255,255,255,.85), rgba(255,255,255,.9)),
        var(--catalog-bg-url);
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      border-bottom:1px solid var(--border);
    }
    body.night header{
      background:
        linear-gradient(to bottom, rgba(15,17,21,.82), rgba(15,17,21,.92)),
        var(--catalog-bg-url);
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
    }
    .topbar{
      max-width:980px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
    }
    .brand h2{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .brand small{
      color:var(--muted);
      display:block;
      margin-top:6px;
      font-size:13px;
      line-height:1.3;
      max-width:56ch;
    }
    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    main{
      max-width:980px;
      margin:0 auto;
      padding:18px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
    }
    @media (min-width: 760px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr));}
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:200px;
    }
    .cover{
      height:160px;
      background:#00000012;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .meta{
      padding:12px 12px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .title{
      margin:0;
      font-size:15px;
      line-height:1.25;
      letter-spacing:.2px;
    }
    .author{
      color:var(--muted);
      font-size:13px;
      margin-top:-6px;
    }
    .cardActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:auto;
    }

    /* ======== Reader overlay ======== */
    .reader{
      position:fixed; inset:0;
      background:var(--bg);
      color:var(--fg);
      display:none;
      flex-direction:column;
      z-index:9000;
    }
    .reader.show{display:flex}

    .readerTop{
      position:sticky;
      top:0;
      z-index:3;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      background:var(--bg);
    }
    .readerTitle{
      flex:1;
      min-width:140px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      font-weight:700;
      letter-spacing:.2px;
    }
    .iconBtn{
      border:1px solid var(--border);
      background:var(--btnbg);
      color:var(--btnfg);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      line-height:1;
      user-select:none;
    }
    .iconBtn:active{transform:translateY(1px)}

    .navBtns{
      display:none;
      gap:10px;
      align-items:center;
    }
    .navBtns.show{display:flex}

    .viewportWrap{
      position:relative;
      flex:1;
      min-height:0;
    }
    /* watermark overlay */
    .viewportWrap::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:var(--reader-wm-url);
      background-size:cover;
      background-position:center;
      opacity:.035;
      filter:grayscale(1);
      z-index:0;
    }
    #viewport{
      position:absolute; inset:0;
      z-index:1;
    }

    .readerBottom{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px;
      border-top:1px solid var(--border);
      background:var(--bg);
      flex-wrap:wrap;
    }
    .status{
      color:var(--muted);
      font-size:13px;
      flex:1;
      min-width:200px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    /* small helpers */
    .srOnly{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      border:0;
    }
  </style>
</head>

<body>
  <!-- Lock overlay -->
  <div id="lock" class="lock" aria-modal="true" role="dialog" aria-labelledby="lockTitle">
    <div class="lockCard">
      <h1 id="lockTitle">Biblioteca bloqueada</h1>
      <p>Digite a senha para acessar. (A senha fica salva neste navegador.)</p>

      <div class="field">
        <label for="pwInput">Senha</label>
        <input id="pwInput" type="password" autocomplete="current-password" inputmode="text" />
        <label class="check" for="pwShow">
          <input id="pwShow" type="checkbox" />
          Mostrar senha
        </label>
      </div>

      <div class="row" style="margin-top:14px;">
        <button id="unlockBtn" class="btn primary" title="Desbloquear a biblioteca" aria-label="Desbloquear">
          Desbloquear
        </button>
        <button id="setPwBtn" class="btn" title="Definir/alterar senha" aria-label="Definir/alterar senha">
          Definir senha
        </button>
        <button id="cancelLockBtn" class="btn" title="Fechar (se nÃ£o houver senha definida)" aria-label="Fechar">
          Fechar
        </button>
      </div>

      <div id="lockError" class="error">Senha incorreta.</div>
      <div class="hint">Dica: se nenhuma senha estiver definida, vocÃª pode fechar.</div>
    </div>
  </div>

  <!-- Catalogue -->
  <header>
    <div class="topbar">
      <div class="brand">
        <h2>Biblioteca</h2>
        <small>Leitor ePub estÃ¡tico (Noblogs) â€” modo noite, retomada de leitura e scroll contÃ­nuo.</small>
      </div>

      <div class="topActions">
        <button id="nightBtn" class="btn" title="Alternar modo noite" aria-label="Modo noite">Noite</button>
        <button id="lockBtn" class="btn" title="Bloquear a biblioteca" aria-label="Bloquear">Bloquear</button>
      </div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-label="Lista de livros"></div>
  </main>

  <!-- Reader overlay -->
  <section id="reader" class="reader" aria-label="Leitor">
    <div class="readerTop">
      <button id="closeReaderBtn" class="iconBtn" title="Fechar leitura" aria-label="Fechar">âœ•</button>
      <div id="readerTitle" class="readerTitle">Leitor</div>

      <button id="toggleFlowBtn" class="iconBtn" title="Alternar modo: rolagem contÃ­nua / pÃ¡ginas" aria-label="Alternar modo">â†•ï¸Ž/â†”ï¸Ž</button>

      <div id="navBtns" class="navBtns">
        <button id="prevBtn" class="iconBtn" title="PÃ¡gina anterior" aria-label="Anterior">â—€</button>
        <button id="nextBtn" class="iconBtn" title="PrÃ³xima pÃ¡gina" aria-label="PrÃ³xima">â–¶</button>
      </div>

      <button id="fontMinusBtn" class="iconBtn" title="Diminuir tamanho da fonte" aria-label="Fonte -">Aâˆ’</button>
      <button id="fontPlusBtn" class="iconBtn" title="Aumentar tamanho da fonte" aria-label="Fonte +">A+</button>
      <button id="themeBtn" class="iconBtn" title="Alternar tema do leitor (claro/escuro)" aria-label="Tema">â˜¾</button>
      <button id="resetBtn" class="iconBtn" title="Voltar para o inÃ­cio do livro" aria-label="InÃ­cio">â¤’</button>
    </div>

    <div class="viewportWrap">
      <div id="viewport"></div>
    </div>

    <div class="readerBottom">
      <div id="status" class="status">â€”</div>
      <button id="clearProgressBtn" class="btn" title="Apagar a posiÃ§Ã£o salva deste livro" aria-label="Apagar posiÃ§Ã£o">Apagar posiÃ§Ã£o</button>
    </div>
  </section>

  <script>
    /**********************
     *  Configuration
     **********************/
    const BOOKS = [
      // ðŸ‘‰ Modifie ici (title, author, cover, epubUrl)
      {
        id: "souza-geografia-libertaria",
        title: "Por uma Geografia libertÃ¡ria",
        author: "Marcelo Lopes de Souza",
        cover: "https://cclamazonia.noblogs.org/files/2024/11/Arte-CCLA-paredao.jpg",
        epubUrl: "books/por-uma-geografia-libertaria.epub"
      },
      // Exemple supplÃ©mentaire
      // {
      //   id: "livro-2",
      //   title: "Outro livro",
      //   author: "Autor",
      //   cover: "covers/livro2.jpg",
      //   epubUrl: "books/livro2.epub"
      // }
    ];

    const LS = {
      night: "lib_night",
      pw: "lib_pw",
      locked: "lib_locked",
      // progress key per book: `lib_progress_${bookId}`
      progress: (bookId) => `lib_progress_${bookId}`,
      // reader preferences
      flow: "reader_flow", // "scrolled" or "paginated"
      fontSize: "reader_font_size", // number (percent)
      readerTheme: "reader_theme" // "light" or "dark"
    };

    /**********************
     *  Elements
     **********************/
    const grid = document.getElementById("grid");
    const nightBtn = document.getElementById("nightBtn");
    const lockBtn = document.getElementById("lockBtn");

    const lock = document.getElementById("lock");
    const pwInput = document.getElementById("pwInput");
    const pwShow = document.getElementById("pwShow");
    const unlockBtn = document.getElementById("unlockBtn");
    const setPwBtn = document.getElementById("setPwBtn");
    const cancelLockBtn = document.getElementById("cancelLockBtn");
    const lockError = document.getElementById("lockError");

    const reader = document.getElementById("reader");
    const viewport = document.getElementById("viewport");
    const readerTitle = document.getElementById("readerTitle");
    const status = document.getElementById("status");

    const closeReaderBtn = document.getElementById("closeReaderBtn");
    const toggleFlowBtn = document.getElementById("toggleFlowBtn");
    const navBtns = document.getElementById("navBtns");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const fontMinusBtn = document.getElementById("fontMinusBtn");
    const fontPlusBtn = document.getElementById("fontPlusBtn");
    const themeBtn = document.getElementById("themeBtn");
    const resetBtn = document.getElementById("resetBtn");
    const clearProgressBtn = document.getElementById("clearProgressBtn");

    /**********************
     *  State
     **********************/
    let currentBook = null;   // object from BOOKS
    let book = null;          // epub.js Book
    let rendition = null;     // epub.js Rendition
    let locationsReady = false;

    function getNight(){ return localStorage.getItem(LS.night) === "1"; }
    function setNight(v){ localStorage.setItem(LS.night, v ? "1" : "0"); }

    function getLocked(){ return localStorage.getItem(LS.locked) === "1"; }
    function setLocked(v){ localStorage.setItem(LS.locked, v ? "1" : "0"); }

    function getPassword(){ return localStorage.getItem(LS.pw) || ""; }
    function setPassword(p){ localStorage.setItem(LS.pw, p || ""); }

    function getFlow(){
      const v = localStorage.getItem(LS.flow);
      return (v === "paginated" || v === "scrolled") ? v : "scrolled";
    }
    function setFlow(v){ localStorage.setItem(LS.flow, v); }

    function getFontSize(){
      const v = parseInt(localStorage.getItem(LS.fontSize) || "110", 10);
      return Number.isFinite(v) ? Math.min(170, Math.max(85, v)) : 110;
    }
    function setFontSize(v){
      const n = Math.min(170, Math.max(85, v));
      localStorage.setItem(LS.fontSize, String(n));
      return n;
    }

    function getReaderTheme(){
      const v = localStorage.getItem(LS.readerTheme);
      return (v === "dark" || v === "light") ? v : "light";
    }
    function setReaderTheme(v){ localStorage.setItem(LS.readerTheme, v); }

    function progressKey(){
      return currentBook ? LS.progress(currentBook.id) : null;
    }
    function saveProgress(cfi){
      const k = progressKey();
      if (!k) return;
      localStorage.setItem(k, cfi);
    }
    function loadProgress(){
      const k = progressKey();
      if (!k) return null;
      return localStorage.getItem(k);
    }
    function clearProgress(){
      const k = progressKey();
      if (!k) return;
      localStorage.removeItem(k);
    }

    /**********************
     *  UI helpers
     **********************/
    function applyNightFromStorage(){
      document.body.classList.toggle("night", getNight());
    }

    function showLock(show){
      lock.classList.toggle("show", !!show);
      lockError.style.display = "none";
      if (show){
        pwInput.focus();
      }
    }

    function normalizePasswordUI(){
      // âœ… Bonus demandÃ© : remettre l'input en password + dÃ©cocher la case
      pwInput.type = "password";
      pwShow.checked = false;
    }

    /**********************
     *  Render catalogue
     **********************/
    function renderCatalogue(){
      grid.innerHTML = "";
      BOOKS.forEach(b => {
        const card = document.createElement("article");
        card.className = "card";

        const cover = document.createElement("div");
        cover.className = "cover";
        if (b.cover){
          const img = document.createElement("img");
          img.alt = `Capa: ${b.title}`;
          img.loading = "lazy";
          img.src = b.cover;
          cover.appendChild(img);
        } else {
          cover.textContent = "Sem capa";
        }

        const meta = document.createElement("div");
        meta.className = "meta";

        const title = document.createElement("h3");
        title.className = "title";
        title.textContent = b.title;

        const author = document.createElement("div");
        author.className = "author";
        author.textContent = b.author || "";

        const actions = document.createElement("div");
        actions.className = "cardActions";

        const readBtn = document.createElement("button");
        readBtn.className = "btn primary";
        readBtn.textContent = "Ler";
        readBtn.title = "Abrir o livro no leitor";
        readBtn.addEventListener("click", () => openBook(b));

        actions.appendChild(readBtn);
        meta.appendChild(title);
        if (b.author) meta.appendChild(author);
        meta.appendChild(actions);

        card.appendChild(cover);
        card.appendChild(meta);

        grid.appendChild(card);
      });
    }

    /**********************
     *  Reader (epub.js)
     **********************/
    function buildThemes(){
      if (!rendition) return;

      // Basic themes
      rendition.themes.register("light", {
        "body": {
          "color": "#111111",
          "background": "#ffffff",
          "font-family": "var(--font-reading)",
          "line-height": "1.55",
          "padding": "0 !important"
        },
        "img": {"max-width":"100%"},
        "a": {"color":"#0b57d0"}
      });

      rendition.themes.register("dark", {
        "body": {
          "color": "#e9edf1",
          "background": "#0f1115",
          "font-family": "var(--font-reading)",
          "line-height": "1.55",
          "padding": "0 !important"
        },
        "img": {"max-width":"100%"},
        "a": {"color":"#9ecbff"}
      });

      // Apply
      const th = getReaderTheme();
      rendition.themes.select(th);
      themeBtn.textContent = (th === "dark") ? "â˜€" : "â˜¾";

      // Font size
      const fs = getFontSize();
      rendition.themes.fontSize(fs + "%");
    }

    function applyFlow(){
      if (!rendition) return;
      const flow = getFlow();
      if (flow === "paginated"){
        rendition.flow("paginated");
        navBtns.classList.add("show");
      } else {
        rendition.flow("scrolled-doc");
        navBtns.classList.remove("show");
      }
      setFlow(flow);
      status.textContent = `Modo: ${flow === "paginated" ? "pÃ¡ginas" : "rolagem contÃ­nua"} â€” Fonte: ${getFontSize()}%`;
    }

    async function openBook(b){
      currentBook = b;
      readerTitle.textContent = b.title || "Leitor";
      reader.classList.add("show");

      // Cleanup previous
      try{
        if (rendition) rendition.destroy();
      }catch(e){}
      try{
        if (book) book.destroy();
      }catch(e){}
      viewport.innerHTML = "";
      locationsReady = false;

      // Create Book
      book = ePub(b.epubUrl);

      // Render
      rendition = book.renderTo("viewport", {
        width: "100%",
        height: "100%",
        spread: "none",
        allowScriptedContent: true
      });

      // Apply theme/flow
      buildThemes();
      applyFlow();

      // Display either saved position or start
      const saved = loadProgress();
      try{
        if (saved){
          await rendition.display(saved);
        } else {
          await rendition.display();
        }
      } catch(err){
        console.error(err);
        await rendition.display();
      }

      // Generate locations (for percentage display)
      book.ready.then(async () => {
        try{
          await book.locations.generate(1200);
          locationsReady = true;
        } catch(e){}
      });

      // Track relocation (save progress)
      rendition.on("relocated", (location) => {
        try{
          const cfi = location?.start?.cfi;
          if (cfi) saveProgress(cfi);

          let pct = "";
          if (locationsReady && cfi && book.locations){
            const p = book.locations.percentageFromCfi(cfi);
            if (Number.isFinite(p)) pct = ` â€” ${(p*100).toFixed(1)}%`;
          }
          status.textContent = `Modo: ${getFlow()==="paginated" ? "pÃ¡ginas" : "rolagem contÃ­nua"} â€” Fonte: ${getFontSize()}%${pct}`;
        } catch(e){}
      });
    }

    function closeReader(){
      reader.classList.remove("show");
      currentBook = null;
      try{ if (rendition) rendition.destroy(); }catch(e){}
      try{ if (book) book.destroy(); }catch(e){}
      rendition = null;
      book = null;
      viewport.innerHTML = "";
      status.textContent = "â€”";
    }

    /**********************
     *  Lock logic
     **********************/
    function requireLockIfNeeded(){
      const pw = getPassword();
      if (pw){
        setLocked(true);
      }
      if (getLocked()){
        showLock(true);
      }
    }

    function tryUnlock(){
      const pw = getPassword();
      if (!pw){
        // nothing set -> allow
        setLocked(false);
        showLock(false);
        return;
      }
      const typed = pwInput.value || "";
      if (typed === pw){
        setLocked(false);
        showLock(false);
        pwInput.value = "";
        lockError.style.display = "none";
      } else {
        lockError.style.display = "block";
      }
    }

    function definePassword(){
      const typed = (pwInput.value || "").trim();
      if (!typed){
        lockError.textContent = "Digite uma senha para definir.";
        lockError.style.display = "block";
        return;
      }
      setPassword(typed);
      setLocked(false);
      showLock(false);
      pwInput.value = "";
      lockError.style.display = "none";
    }

    function lockNow(){
      setLocked(true);
      showLock(true);
      // âœ… Bonus demandÃ© au clic â€œBloquearâ€
      normalizePasswordUI();
      pwInput.value = "";
    }

    /**********************
     *  Events
     **********************/
    nightBtn.addEventListener("click", () => {
      const v = !getNight();
      setNight(v);
      applyNightFromStorage();
    });

    lockBtn.addEventListener("click", () => {
      lockNow();
      closeReader(); // optional: close reader when locking
    });

    pwShow.addEventListener("change", () => {
      pwInput.type = pwShow.checked ? "text" : "password";
      pwInput.focus();
    });

    unlockBtn.addEventListener("click", tryUnlock);
    setPwBtn.addEventListener("click", definePassword);

    cancelLockBtn.addEventListener("click", () => {
      // only close if no password exists
      if (!getPassword()){
        setLocked(false);
        showLock(false);
        pwInput.value = "";
        lockError.style.display = "none";
      } else {
        lockError.textContent = "Uma senha jÃ¡ estÃ¡ definida. Digite-a para desbloquear.";
        lockError.style.display = "block";
      }
    });

    pwInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") tryUnlock();
    });

    closeReaderBtn.addEventListener("click", closeReader);

    toggleFlowBtn.addEventListener("click", () => {
      const flow = getFlow() === "scrolled" ? "paginated" : "scrolled";
      setFlow(flow);
      applyFlow();
      // Keep current position
      const saved = loadProgress();
      if (saved && rendition){
        rendition.display(saved).catch(()=>{});
      }
    });

    prevBtn.addEventListener("click", () => { if (rendition) rendition.prev(); });
    nextBtn.addEventListener("click", () => { if (rendition) rendition.next(); });

    fontMinusBtn.addEventListener("click", () => {
      const n = setFontSize(getFontSize() - 5);
      if (rendition) rendition.themes.fontSize(n + "%");
      status.textContent = `Modo: ${getFlow()==="paginated" ? "pÃ¡ginas" : "rolagem contÃ­nua"} â€” Fonte: ${n}%`;
    });

    fontPlusBtn.addEventListener("click", () => {
      const n = setFontSize(getFontSize() + 5);
      if (rendition) rendition.themes.fontSize(n + "%");
      status.textContent = `Modo: ${getFlow()==="paginated" ? "pÃ¡ginas" : "rolagem contÃ­nua"} â€” Fonte: ${n}%`;
    });

    themeBtn.addEventListener("click", () => {
      const cur = getReaderTheme();
      const nxt = (cur === "dark") ? "light" : "dark";
      setReaderTheme(nxt);
      if (rendition) rendition.themes.select(nxt);
      themeBtn.textContent = (nxt === "dark") ? "â˜€" : "â˜¾";
    });

    resetBtn.addEventListener("click", () => {
      if (!rendition) return;
      clearProgress();
      rendition.display().catch(()=>{});
    });

    clearProgressBtn.addEventListener("click", () => {
      clearProgress();
      status.textContent = "PosiÃ§Ã£o apagada para este livro.";
    });

    // ESC closes reader or lock
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        if (lock.classList.contains("show")){
          // do nothing if password exists; allow close only if no password
          if (!getPassword()){
            setLocked(false);
            showLock(false);
          }
          return;
        }
        if (reader.classList.contains("show")) closeReader();
      }
    });

    /**********************
     *  Boot
     **********************/
    applyNightFromStorage();
    renderCatalogue();
    requireLockIfNeeded();
  </script>
</body>
</html>
