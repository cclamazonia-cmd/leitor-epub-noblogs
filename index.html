<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Biblioteca</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#ffffff;
  --fg:#111111;
  --muted:#666666;
  --card:#f5f5f5;
  --border:#dddddd;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#111111;
  --accentfg:#ffffff;

  --radius:16px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
  --font-ui:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  --font-reading:ui-serif,"Georgia","Times New Roman",Times,serif;
}

body.night{
  --bg:#0f1115;
  --fg:#e9edf1;
  --muted:#a6b0bb;
  --card:#171a21;
  --border:#262b36;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#e9edf1;
  --accentfg:#0f1115;

  --shadow:0 12px 34px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:var(--font-ui);
  background:var(--bg);
  color:var(--fg);
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:color-mix(in srgb, var(--bg) 92%, transparent);
  backdrop-filter:saturate(140%) blur(8px);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.brand{display:flex;flex-direction:column;gap:2px}
header strong{font-size:16px;letter-spacing:.2px}
.tagline{font-size:12px;color:var(--muted)}

.btn{
  padding:10px 12px;
  border:1px solid var(--border);
  background:var(--btnbg);
  color:var(--btnfg);
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  transition:transform .08s ease, background .15s ease, border-color .15s ease;
  user-select:none;
}
.btn:hover{background:color-mix(in srgb, var(--card) 55%, var(--bg))}
.btn:active{transform:scale(.98)}
.btn:focus{outline:2px solid color-mix(in srgb, var(--accent) 35%, transparent);outline-offset:2px}

.btn-primary{
  border-color:transparent;
  background:var(--accent);
  color:var(--accentfg);
}

main{
  max-width:980px;
  margin:18px auto;
  padding:0 16px 24px;
}
body.reader-open main{max-width:min(1200px, 96vw)}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

h2{margin:0 0 8px 0;font-size:18px}
p{margin:0 0 12px 0;color:var(--muted);line-height:1.55}

.book{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding:14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--bg);
  margin-bottom:12px;
}
.book strong{display:block;font-size:16px;letter-spacing:.2px}
.book small{color:var(--muted);display:block;margin-top:2px}

.reader-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

.reader-title{
  font-size:14px;
  color:var(--muted);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:70%;
}

.viewer{
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  background:var(--bg);
}

.viewer-toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--border);
  background:var(--card);
}

.viewer-left,.viewer-right{
  display:flex;
  align-items:center;
  gap:8px;
  min-width: 180px;
}
.viewer-left{justify-content:flex-start}
.viewer-right{justify-content:flex-end}

.viewer-center{
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:center;
}

.viewer-hint{
  color:var(--muted);
  font-size:13px;
  min-width: 180px;
  text-align:center;
}

/* Badges */
.pill{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  white-space:nowrap;
}

.save-badge{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  opacity:0;
  transform:translateY(2px);
  transition:opacity .18s ease, transform .18s ease;
  white-space:nowrap;
}
.save-badge.show{
  opacity:1;
  transform:translateY(0);
}

#viewer{
  width:100%;
  height: calc(100vh - 230px);
  background:var(--bg);
}

.notice{
  margin-top:10px;
  padding:10px;
  border:1px dashed var(--border);
  border-radius:12px;
  color:var(--muted);
  background:color-mix(in srgb, var(--card) 75%, var(--bg));
}

code{
  padding:2px 6px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--bg);
  color:var(--fg);
}

.footer{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:28px 16px 40px;
}
.footer-logo{max-height:150px;width:auto;display:block}
body.reader-open .footer{display:none}
</style>
</head>

<body>
<header>
  <div class="brand">
    <strong>Biblioteca</strong>
    <span class="tagline">Leitor EPUB ‚Ä¢ Editora CCLA</span>
  </div>
  <button class="btn" id="toggleNight" type="button" aria-label="Alternar tema">üåô Noite</button>
</header>

<main>
  <section id="catalogo" class="card">
    <h2>Cat√°logo</h2>
    <p>Escolha um livro para abrir no leitor.</p>
    <div id="books"></div>
  </section>

  <section id="leitor" class="card" style="display:none;">
    <div class="reader-top">
      <button class="btn" id="backBtn" type="button">‚Üê Cat√°logo</button>
      <div class="reader-title" id="bookTitle">Carregando‚Ä¶</div>
    </div>

    <div class="viewer">
      <div class="viewer-toolbar">
        <div class="viewer-left">
          <button class="btn" id="prevBtn" type="button" aria-label="P√°gina anterior">‚Üê</button>
          <button class="btn" id="restartBtn" type="button" aria-label="Recome√ßar do in√≠cio">Recome√ßar</button>
        </div>

        <div class="viewer-center">
          <button class="btn" id="fontMinus" type="button" aria-label="Diminuir fonte">A‚àí</button>
          <div class="viewer-hint" id="progress">‚Äî</div>
          <button class="btn" id="fontPlus" type="button" aria-label="Aumentar fonte">A+</button>
        </div>

        <div class="viewer-right">
          <span class="pill" id="timePill" aria-label="Tempo de leitura">Tempo: 00:00</span>
          <span class="save-badge" id="saveBadge" aria-live="polite">√öltima leitura salva ‚úÖ</span>
          <button class="btn" id="nextBtn" type="button" aria-label="Pr√≥xima p√°gina">‚Üí</button>
        </div>
      </div>

      <div id="viewer" aria-label="√Årea de leitura"></div>
    </div>

    <div id="errorBox" class="notice" style="display:none;"></div>
  </section>
</main>

<footer class="footer" aria-label="Editora CCLA">
  <img class="footer-logo" src="assets/logo/ccla_editora.png" alt="Editora CCLA">
</footer>

<script src="jszip.min.js"></script>
<script src="epub.min.js"></script>
<script>
(() => {
  "use strict";

  // ====== CONFIG ======
  const BOOKS = [
    { id: "extrativismo", title: "Extrativismo", author: "Anna Bednik e J√©r√©my Dotti", file: "extrativismo.epub" },
    { id: "geografia-libertaria", title: "Por uma Geografia libert√°ria", author: "Marcelo Lopes de Souza", file: "mls.epub" }
  ];

  // ====== DOM ======
  const elCatalogo = document.getElementById("catalogo");
  const elLeitor = document.getElementById("leitor");
  const elBooks = document.getElementById("books");
  const elTitle = document.getElementById("bookTitle");
  const elProgress = document.getElementById("progress");
  const elError = document.getElementById("errorBox");
  const elSaveBadge = document.getElementById("saveBadge");
  const elTimePill = document.getElementById("timePill");

  const btnNight = document.getElementById("toggleNight");
  const btnBack = document.getElementById("backBtn");
  const btnPrev = document.getElementById("prevBtn");
  const btnNext = document.getElementById("nextBtn");
  const btnRestart = document.getElementById("restartBtn");
  const btnFontMinus = document.getElementById("fontMinus");
  const btnFontPlus  = document.getElementById("fontPlus");

  // ====== STATE ======
  let book = null;
  let rendition = null;
  let currentItem = null;

  // Font size persisted
  let fontPct = Number(localStorage.getItem("fontPct") || 110);

  // Badge timer
  let saveBadgeTimer = null;

  // Reading timer (30s ticks)
  let readingSeconds = 0;
  let readingTimerId = null;

  // Promise for locations readiness (progress %)
  let locReadyPromise = Promise.resolve(false);

  // ====== UTIL ======
  function escapeHtml(value) {
    return String(value ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function showError(message) {
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function clearError() {
    elError.style.display = "none";
    elError.textContent = "";
  }

  function showReader() {
    elCatalogo.style.display = "none";
    elLeitor.style.display = "block";
    document.body.classList.add("reader-open");
  }

  function showCatalog() {
    elLeitor.style.display = "none";
    elCatalogo.style.display = "block";
    document.body.classList.remove("reader-open");
  }

  function showSavedBadge() {
    if (!elSaveBadge) return;
    elSaveBadge.classList.add("show");
    if (saveBadgeTimer) clearTimeout(saveBadgeTimer);
    saveBadgeTimer = setTimeout(() => elSaveBadge.classList.remove("show"), 1400);
  }

  // ====== PROGRESS SAVE (CFI) ======
  function storageKeyForBook(item) {
    return "pos:" + (item && item.id ? item.id : "unknown");
  }
  function timeKeyForBook(item) {
    return "time:" + (item && item.id ? item.id : "unknown");
  }

  function savePosition(item, location) {
    try {
      const cfi = location && location.start && location.start.cfi;
      if (!cfi) return;
      localStorage.setItem(storageKeyForBook(item), cfi);
      showSavedBadge();
    } catch(e) { /* ignore */ }
  }

  function loadPosition(item) {
    try { return localStorage.getItem(storageKeyForBook(item)); }
    catch(e){ return null; }
  }

  function clearPosition(item) {
    try { localStorage.removeItem(storageKeyForBook(item)); }
    catch(e){ /* ignore */ }
  }

  // ====== LOCATIONS (for % progress) ======
  function locKeyForBook(item){
    return "loc:" + (item && item.id ? item.id : "unknown");
  }

  async function ensureLocations(item){
    if (!book || !book.locations) return false;

    try {
      // already loaded?
      if (typeof book.locations.length === "function" && book.locations.length() > 0) return true;

      // try load cached locations
      const saved = localStorage.getItem(locKeyForBook(item));
      if (saved) {
        book.locations.load(saved);
        if (book.locations.length() > 0) return true;
      }

      // generate locations (needed for a stable %)
      await book.locations.generate(1024);

      // cache for next time
      try {
        localStorage.setItem(locKeyForBook(item), book.locations.save());
      } catch(e) { /* ignore quota errors */ }

      return (typeof book.locations.length === "function" && book.locations.length() > 0);
    } catch(e) {
      return false;
    }
  }

  function percentFromLocation(location){
    // 1) direct percentage if provided
    const p = location && location.start && location.start.percentage;
    if (typeof p === "number" && isFinite(p)) return Math.max(0, Math.min(1, p));

    // 2) fallback via CFI + locations
    const cfi = location && location.start && location.start.cfi;
    if (cfi && book && book.locations && typeof book.locations.percentageFromCfi === "function") {
      const px = book.locations.percentageFromCfi(cfi);
      if (typeof px === "number" && isFinite(px)) return Math.max(0, Math.min(1, px));
    }

    return null;
  }

  // ====== READING TIME ======
  function loadReadingTime(item){
    try {
      const v = Number(localStorage.getItem(timeKeyForBook(item)) || 0);
      return Number.isFinite(v) && v >= 0 ? v : 0;
    } catch(e){
      return 0;
    }
  }

  function saveReadingTime(item){
    try {
      localStorage.setItem(timeKeyForBook(item), String(readingSeconds));
    } catch(e){ /* ignore */ }
  }

  function formatTime(sec){
    const s = Math.max(0, Math.floor(sec));
    const mm = Math.floor(s / 60);
    const ss = s % 60;
    const m2 = String(mm).padStart(2,"0");
    const s2 = String(ss).padStart(2,"0");
    return `${m2}:${s2}`;
  }

  function updateTimeUI(){
    if (!elTimePill) return;
    elTimePill.textContent = `Tempo: ${formatTime(readingSeconds)}`;
  }

  function stopReadingTimer(){
    if (readingTimerId) clearInterval(readingTimerId);
    readingTimerId = null;
  }

  function startReadingTimer(){
    stopReadingTimer();
    updateTimeUI();

    readingTimerId = setInterval(() => {
      const readerOpen = document.body.classList.contains("reader-open");
      if (!readerOpen) return;
      if (document.visibilityState !== "visible") return;
      if (!currentItem) return;

      readingSeconds += 30;
      saveReadingTime(currentItem);
      updateTimeUI();
    }, 30000);
  }

  document.addEventListener("visibilitychange", () => {
    if (!currentItem) return;
    updateTimeUI();
  });

  // ====== READING PREFS ======
  function applyReadingPrefs() {
    if (!rendition) return;
    try {
      rendition.themes.fontSize(fontPct + "%");
      localStorage.setItem("fontPct", String(fontPct));
    } catch(e) {}
  }

  // ====== THEME ======
  function applyThemeToRendition() {
    if (!rendition) return;

    const night = document.body.classList.contains("night");

    rendition.themes.register("app", {
      "body": {
        "background": night ? "#0f1115" : "#ffffff",
        "color": night ? "#e9edf1" : "#111111",
        "line-height": "1.65",
        "text-rendering": "optimizeLegibility"
      },
      "p": { "line-height": "1.65", "margin": "0 0 1em 0" },
      "h1,h2,h3": { "line-height": "1.25", "margin": "1.2em 0 .6em 0" },
      "a": { "color": night ? "#8ab4f8" : "#0b57d0" }
    });

    rendition.themes.select("app");

    try {
      rendition.themes.override("body", "padding", "18px 18px 24px 18px");
      rendition.themes.override("body", "margin", "0");
      rendition.themes.override("html", "margin", "0");
    } catch(e) {}

    applyReadingPrefs();
  }

  function setTheme(isNight) {
    document.body.classList.toggle("night", isNight);
    localStorage.setItem("theme", isNight ? "night" : "day");
    btnNight.textContent = isNight ? "‚òÄÔ∏è Dia" : "üåô Noite";
    btnNight.setAttribute("aria-label", isNight ? "Ativar modo dia" : "Ativar modo noite");
    applyThemeToRendition();
  }

  function initTheme() {
    const saved = localStorage.getItem("theme");
    setTheme(saved === "night");
    btnNight.addEventListener("click", () => setTheme(!document.body.classList.contains("night")));
  }

  // ====== UI ======
  function renderCatalog() {
    if (!elBooks) return;

    if (!Array.isArray(BOOKS) || BOOKS.length === 0) {
      elBooks.innerHTML = `
        <div class="notice">
          Nenhum livro configurado.<br>
          Adicione arquivos <code>.epub</code> em <code>epubs/</code> e atualize a lista no c√≥digo.
        </div>
      `;
      return;
    }

    elBooks.innerHTML = BOOKS.map(b => `
      <div class="book">
        <div>
          <strong>${escapeHtml(b.title)}</strong>
          <small>${escapeHtml(b.author || "")}</small>
        </div>
        <button class="btn btn-primary" type="button" data-book="${escapeHtml(b.id)}">Ler</button>
      </div>
    `).join("");

    elBooks.querySelectorAll("button[data-book]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-book");
        const item = BOOKS.find(x => x.id === id);
        if (item) openBook(item);
      });
    });
  }

  function updateProgressUI(location){
    const displayed = location && location.start && location.start.displayed;
    const percent = percentFromLocation(location);

    const pagePart = (displayed && displayed.page && displayed.total)
      ? `P√°gina ${displayed.page} / ${displayed.total}`
      : "‚Äî";

    const pctPart = (percent !== null)
      ? ` ‚Ä¢ ${Math.round(percent * 100)}%`
      : "";

    elProgress.textContent = pagePart + pctPart;
  }

  // ====== EPUB ======
  async function openBook(item) {
    clearError();

    currentItem = item;
    readingSeconds = loadReadingTime(item);
    updateTimeUI();

    showReader();
    elTitle.textContent = item.title || "Livro";

    const savedCfi = loadPosition(item);
    elProgress.textContent = savedCfi ? "Retomando‚Ä¶" : "Carregando‚Ä¶";
    if (elSaveBadge) elSaveBadge.classList.remove("show");

    startReadingTimer();

    if (typeof window.ePub !== "function") {
      showError(
        "N√£o consegui carregar o epub.js.\n" +
        "Verifique se existe o arquivo: epub.min.js\n" +
        "na mesma pasta do arquivo HTML."
      );
      elProgress.textContent = "‚Äî";
      return;
    }

    try {
      if (rendition) {
        try { rendition.destroy(); } catch(e) {}
        rendition = null;
      }
      book = null;

      const path = "epubs/" + item.file;

      const resp = await fetch(path);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const arrayBuffer = await resp.arrayBuffer();

      book = window.ePub(arrayBuffer);

      // prepare locations for % progress (async, cached)
      locReadyPromise = ensureLocations(item);

      rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        spread: "none"
      });

      btnPrev.onclick = () => rendition && rendition.prev();
      btnNext.onclick = () => rendition && rendition.next();

      btnRestart.onclick = async () => {
        if (!currentItem || !rendition) return;
        clearPosition(currentItem);
        elProgress.textContent = "Carregando‚Ä¶";
        try { await rendition.display(); } catch(e) {}
      };

      btnFontMinus.onclick = () => {
        fontPct = Math.max(80, fontPct - 10);
        applyReadingPrefs();
      };
      btnFontPlus.onclick = () => {
        fontPct = Math.min(200, fontPct + 10);
        applyReadingPrefs();
      };

      rendition.on("relocated", (location) => {
        savePosition(item, location);
        updateProgressUI(location);
      });

      rendition.on("rendered", () => applyThemeToRendition());

      if (savedCfi) {
        await rendition.display(savedCfi);
      } else {
        await rendition.display();
      }

      applyThemeToRendition();

      // Ensure locations ready then force a first % update
      try {
        await locReadyPromise;
        const loc = rendition && rendition.currentLocation ? rendition.currentLocation() : null;
        if (loc) updateProgressUI(loc);
      } catch(e) { /* ignore */ }

    } catch (err) {
      console.error(err);
      showError(
        "Falha ao abrir o EPUB.\n" +
        "Detalhe t√©cnico: " + (err && err.message ? err.message : String(err))
      );
      elProgress.textContent = "‚Äî";
    }
  }

  btnBack.addEventListener("click", () => {
    clearError();
    stopReadingTimer();
    showCatalog();
  });

  initTheme();
  renderCatalog();
})();
</script>

</body>
</html>
