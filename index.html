<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Biblioteca</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#ffffff;
  --fg:#111111;
  --muted:#666666;
  --card:#f5f5f5;
  --border:#dddddd;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#111111;
  --accentfg:#ffffff;

  --radius:16px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
  --font-ui:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  --font-reading:ui-serif,"Georgia","Times New Roman",Times,serif;
}

body.night{
  --bg:#0f1115;
  --fg:#e9edf1;
  --muted:#a6b0bb;
  --card:#171a21;
  --border:#262b36;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#e9edf1;
  --accentfg:#0f1115;

  --shadow:0 12px 34px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:var(--font-ui);
  background:var(--bg);
  color:var(--fg);
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:color-mix(in srgb, var(--bg) 92%, transparent);
  backdrop-filter:saturate(140%) blur(8px);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.brand{display:flex;flex-direction:column;gap:2px}
header strong{font-size:16px;letter-spacing:.2px}
.tagline{font-size:12px;color:var(--muted)}

.btn{
  padding:10px 12px;
  border:1px solid var(--border);
  background:var(--btnbg);
  color:var(--btnfg);
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  transition:transform .08s ease, background .15s ease, border-color .15s ease;
  user-select:none;
  white-space:nowrap;
}
.btn:hover{background:color-mix(in srgb, var(--card) 55%, var(--bg))}
.btn:active{transform:scale(.98)}
.btn:focus{outline:2px solid color-mix(in srgb, var(--accent) 35%, transparent);outline-offset:2px}
.btn-primary{border-color:transparent;background:var(--accent);color:var(--accentfg)}
.btn[disabled]{opacity:.55;cursor:not-allowed}

main{
  max-width:980px;
  margin:18px auto;
  padding:0 16px 24px;
}
body.reader-open main{max-width:min(1200px, 96vw)}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

h2{margin:0 0 8px 0;font-size:18px}
p{margin:0 0 12px 0;color:var(--muted);line-height:1.55}

.book{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding:14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--bg);
  margin-bottom:12px;
}
.book strong{display:block;font-size:16px;letter-spacing:.2px}
.book small{color:var(--muted);display:block;margin-top:2px}

.reader-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

.reader-title{
  font-size:14px;
  color:var(--muted);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:70%;
}

.viewer{
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  background:var(--bg);
  position:relative;
}

.viewer-toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--border);
  background:var(--card);
}

.viewer-left,.viewer-center,.viewer-right{
  display:flex;
  align-items:center;
  gap:8px;
}

.viewer-left{justify-content:flex-start; flex-wrap:wrap}
.viewer-center{justify-content:center; flex:1; min-width:240px;}
.viewer-right{justify-content:flex-end; gap:8px; flex-wrap:wrap;}

.layout-controls{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.pill,.save-badge{white-space:nowrap}

.viewer-hint{
  color:var(--muted);
  font-size:13px;
  min-width: 180px;
  text-align:center;
}

.pill{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
}

.save-badge{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  opacity:0;
  transform:translateY(2px);
  transition:opacity .18s ease, transform .18s ease;
}
.save-badge.show{opacity:1;transform:translateY(0)}

#viewer{
  width:100%;
  height: calc(100vh - 280px);
  background:var(--bg);
}

/* Toolbar en grid plus t√¥t => pas de chevauchement */
@media (max-width: 1100px){
  .viewer-toolbar{
    display:grid;
    grid-template-columns: 1fr 1fr;
    grid-template-areas:
      "left right"
      "center center";
    gap:10px;
  }
  .viewer-left{grid-area:left}
  .viewer-right{grid-area:right}
  .viewer-center{grid-area:center; justify-content:center; min-width:0}
  .viewer-hint{min-width:0}
}

@media (max-width: 620px){
  .viewer-toolbar{
    grid-template-columns: 1fr;
    grid-template-areas:
      "left"
      "center"
      "right";
  }
  .viewer-left,.viewer-center,.viewer-right{
    justify-content:space-between;
  }
  .layout-controls{
    justify-content:flex-start;
  }
  .viewer-right{gap:10px;}
  .btn{padding:9px 10px; font-size:13px; border-radius:11px}
  .pill,.save-badge{font-size:11px; padding:5px 8px}
}

.fullscreen-exit{
  position:absolute;
  top:10px;
  right:10px;
  z-index:50;
  display:none;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:color-mix(in srgb, var(--bg) 85%, var(--card));
  color:var(--fg);
  cursor:pointer;
  font-size:14px;
  box-shadow:var(--shadow);
  opacity:0;
  transform:translateY(-2px);
  transition:opacity .18s ease, transform .18s ease;
}
.fullscreen-exit.show{opacity:1;transform:translateY(0)}

.viewer:fullscreen{
  border-radius:0;
  border:0;
  width:100vw;
  height:100vh;
  background:var(--bg);
}
.viewer:fullscreen #viewer{height: calc(100vh - 64px);}
.viewer:fullscreen .fullscreen-exit{
  display:inline-flex;
  align-items:center;
  gap:8px;
}

body.fs header{display:none}
body.fs main{margin:0; padding:0}
body.fs .card{border-radius:0; box-shadow:none; margin:0; padding:0; border:0}
body.fs .reader-top{display:none}

.notice{
  margin-top:10px;
  padding:10px;
  border:1px dashed var(--border);
  border-radius:12px;
  color:var(--muted);
  background:color-mix(in srgb, var(--card) 75%, var(--bg));
}

code{
  padding:2px 6px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--bg);
  color:var(--fg);
}

.footer{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:28px 16px 40px;
}
.footer-logo{max-height:150px;width:auto;display:block}
body.reader-open .footer{display:none}
</style>
</head>

<body>
<header>
  <div class="brand">
    <strong>Biblioteca</strong>
    <span class="tagline">Leitor EPUB ‚Ä¢ Editora CCLA</span>
  </div>
  <button class="btn" id="toggleNight" type="button" aria-label="Alternar tema">üåô Noite</button>
</header>

<main>
  <section id="catalogo" class="card">
    <h2>Cat√°logo</h2>
    <p>Escolha um livro para abrir no leitor.</p>
    <div id="books"></div>
  </section>

  <section id="leitor" class="card" style="display:none;">
    <div class="reader-top">
      <button class="btn" id="backBtn" type="button">‚Üê Cat√°logo</button>
      <div class="reader-title" id="bookTitle">Carregando‚Ä¶</div>
    </div>

    <div class="viewer" id="viewerShell">
      <div class="viewer-toolbar">
        <div class="viewer-left">
          <button class="btn" id="prevBtn" type="button" aria-label="P√°gina anterior">‚Üê</button>
          <button class="btn" id="restartBtn" type="button" aria-label="Recome√ßar do in√≠cio">Recome√ßar</button>
          <button class="btn" id="fsBtn" type="button" aria-label="Tela cheia">‚õ∂</button>
        </div>

        <div class="viewer-center">
          <button class="btn" id="fontMinus" type="button" aria-label="Diminuir fonte">A‚àí</button>
          <div class="viewer-hint" id="progress">‚Äî</div>
          <button class="btn" id="fontPlus" type="button" aria-label="Aumentar fonte">A+</button>
        </div>

        <div class="viewer-right">
          <div class="layout-controls">
            <button class="btn" id="flowBtn" type="button" aria-label="Alternar modo de leitura">üìÑ</button>
            <button class="btn" id="spreadBtn" type="button" aria-label="Alternar colunas">Colunas</button>
            <button class="btn" id="marginBtn" type="button" aria-label="Ajustar margens">Margens</button>
            <button class="btn" id="widthBtn" type="button" aria-label="Ajustar largura do texto">Largura</button>
            <button class="btn" id="justifyBtn" type="button" aria-label="Justifica√ß√£o">J</button>
            <button class="btn" id="hyphenBtn" type="button" aria-label="Hifeniza√ß√£o">Hy</button>
          </div>

          <span class="pill" id="timePill" aria-label="Tempo de leitura">Tempo: 00:00</span>
          <span class="save-badge" id="saveBadge" aria-live="polite">√öltima leitura salva ‚úÖ</span>
          <button class="btn" id="nextBtn" type="button" aria-label="Pr√≥xima p√°gina">‚Üí</button>
        </div>
      </div>

      <button class="fullscreen-exit" id="fsExitBtn" type="button" aria-label="Sair da tela cheia">‚§´ Sair</button>
      <div id="viewer" aria-label="√Årea de leitura"></div>
    </div>

    <div id="errorBox" class="notice" style="display:none;"></div>
  </section>
</main>

<footer class="footer" aria-label="Editora CCLA">
  <img class="footer-logo" src="assets/logo/ccla_editora.png" alt="Editora CCLA">
</footer>

<script src="jszip.min.js"></script>
<script src="epub.min.js"></script>
<script>
(() => {
  "use strict";

  // ====== CONFIG ======
  // pagination: on la d√©sactive par livre si elle est instable
  const BOOKS = [
    { id: "extrativismo", title: "Extrativismo", author: "Anna Bednik e J√©r√©my Dotti", file: "extrativismo.epub", pagination: false, nudge: false },
    { id: "geografia-libertaria", title: "Por uma Geografia libert√°ria", author: "Marcelo Lopes de Souza", file: "mls.epub", pagination: false, nudge: true }
  ];

  // ====== DOM ======
  const elCatalogo = document.getElementById("catalogo");
  const elLeitor = document.getElementById("leitor");
  const elBooks = document.getElementById("books");
  const elTitle = document.getElementById("bookTitle");
  const elProgress = document.getElementById("progress");
  const elError = document.getElementById("errorBox");
  const elSaveBadge = document.getElementById("saveBadge");
  const elTimePill = document.getElementById("timePill");

  const btnNight = document.getElementById("toggleNight");
  const btnBack = document.getElementById("backBtn");
  const btnPrev = document.getElementById("prevBtn");
  const btnNext = document.getElementById("nextBtn");
  const btnRestart = document.getElementById("restartBtn");
  const btnFontMinus = document.getElementById("fontMinus");
  const btnFontPlus  = document.getElementById("fontPlus");

  // Fullscreen
  const viewerShell = document.getElementById("viewerShell");
  const btnFs = document.getElementById("fsBtn");
  const btnFsExit = document.getElementById("fsExitBtn");

  // Layout controls
  const btnFlow   = document.getElementById("flowBtn");
  const btnSpread = document.getElementById("spreadBtn");
  const btnMargin = document.getElementById("marginBtn");
  const btnWidth  = document.getElementById("widthBtn");
  const btnJustify= document.getElementById("justifyBtn");
  const btnHyphen = document.getElementById("hyphenBtn");

  // ====== STATE ======
  let book = null;
  let rendition = null;
  let currentItem = null;

  let fontPct = Number(localStorage.getItem("fontPct") || 110);

  let saveBadgeTimer = null;

  // Layout prefs
  let flowMode   = localStorage.getItem("flowMode") || "scrolled-doc"; // default plus stable
  if (flowMode !== "paginated" && flowMode !== "scrolled-doc") flowMode = "scrolled-doc";

  let spreadMode = localStorage.getItem("spreadMode") || "none";
  if (spreadMode !== "none" && spreadMode !== "auto") spreadMode = "none";

  let marginPx   = Number(localStorage.getItem("marginPx") || 18);
  let maxWidthCh = Number(localStorage.getItem("maxWidthCh") || 72);
  let justifyOn  = (localStorage.getItem("justifyOn") || "0") === "1";
  let hyphenOn   = (localStorage.getItem("hyphenOn") || "1") === "1";
  let columnGap  = Number(localStorage.getItem("columnGap") || 28);

  const MARGIN_STEPS = [12,18,24,30];
  const WIDTH_STEPS  = [0,60,72,84];

  // Timer lecture
  let readingSeconds = 0;
  let rafId = null;
  let lastTs = null;
  let carryMs = 0;
  const CHUNK_MS = 30000;

  // CSS inject√©
  let injectedCss = "";
  let hookInstalled = false;

  function escapeHtml(value) {
    return String(value ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function showNotice(message) {
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function showError(message) {
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function clearError() {
    elError.style.display = "none";
    elError.textContent = "";
  }

  function showReader() {
    elCatalogo.style.display = "none";
    elLeitor.style.display = "block";
    document.body.classList.add("reader-open");
  }

  function showCatalog() {
    elLeitor.style.display = "none";
    elCatalogo.style.display = "block";
    document.body.classList.remove("reader-open");
  }

  function showSavedBadge() {
    if (!elSaveBadge) return;
    elSaveBadge.classList.add("show");
    if (saveBadgeTimer) clearTimeout(saveBadgeTimer);
    saveBadgeTimer = setTimeout(() => elSaveBadge.classList.remove("show"), 1400);
  }

  function storageKeyForBook(item) { return "pos:" + (item && item.id ? item.id : "unknown"); }
  function timeKeyForBook(item)    { return "time:" + (item && item.id ? item.id : "unknown"); }

  function savePosition(item, location) {
    try {
      const cfi = location && location.start && location.start.cfi;
      if (!cfi) return;
      localStorage.setItem(storageKeyForBook(item), cfi);
      showSavedBadge();
    } catch(e) {}
  }

  function loadPosition(item) {
    try { return localStorage.getItem(storageKeyForBook(item)); }
    catch(e){ return null; }
  }

  function clearPosition(item) {
    try { localStorage.removeItem(storageKeyForBook(item)); }
    catch(e){}
  }

  function loadReadingTime(item){
    try {
      const v = Number(localStorage.getItem(timeKeyForBook(item)) || 0);
      return Number.isFinite(v) && v >= 0 ? v : 0;
    } catch(e){ return 0; }
  }

  function saveReadingTime(item){
    try { localStorage.setItem(timeKeyForBook(item), String(readingSeconds)); } catch(e){}
  }

  function formatTime(sec){
    const s = Math.max(0, Math.floor(sec));
    const mm = Math.floor(s / 60);
    const ss = s % 60;
    return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
  }

  function updateTimeUI(){
    if (!elTimePill) return;
    elTimePill.textContent = `Tempo: ${formatTime(readingSeconds)}`;
  }

  function commitChunks(){
    const chunks = Math.floor(carryMs / CHUNK_MS);
    if (chunks > 0) {
      readingSeconds += chunks * 30;
      carryMs -= chunks * CHUNK_MS;
      if (currentItem) saveReadingTime(currentItem);
      updateTimeUI();
    }
  }

  function isReadingActive(){
    return document.body.classList.contains("reader-open")
      && document.visibilityState === "visible"
      && !!currentItem;
  }

  function rafLoop(ts){
    if (lastTs === null) lastTs = ts;
    let dt = ts - lastTs;
    lastTs = ts;

    if (!Number.isFinite(dt) || dt < 0) dt = 0;
    if (dt > 5000) dt = 0;

    if (isReadingActive()) {
      carryMs += dt;
      commitChunks();
    }
    rafId = requestAnimationFrame(rafLoop);
  }

  function startReadingTimer(){
    stopReadingTimer();
    carryMs = 0;
    lastTs = null;
    updateTimeUI();
    rafId = requestAnimationFrame(rafLoop);
  }

  function stopReadingTimer(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    commitChunks();
    carryMs = 0;
    lastTs = null;
  }

  window.addEventListener("pagehide", () => {
    if (currentItem) saveReadingTime(currentItem);
  });

  function applyReadingPrefs() {
    if (!rendition) return;
    try {
      rendition.themes.fontSize(fontPct + "%");
      localStorage.setItem("fontPct", String(fontPct));
    } catch(e) {}
  }

  function persistLayoutPrefs(){
    try {
      localStorage.setItem("flowMode", flowMode);
      localStorage.setItem("spreadMode", spreadMode);
      localStorage.setItem("marginPx", String(marginPx));
      localStorage.setItem("maxWidthCh", String(maxWidthCh));
      localStorage.setItem("justifyOn", justifyOn ? "1" : "0");
      localStorage.setItem("hyphenOn",  hyphenOn ? "1" : "0");
      localStorage.setItem("columnGap", String(columnGap));
    } catch(e){}
  }

  function labelFlow(){ return (flowMode === "paginated") ? "üìÑ" : "üìú"; }
  function labelSpread(){ return (spreadMode === "auto") ? "2 col" : "1 col"; }
  function labelMargin(){ return `M ${marginPx}`; }
  function labelWidth(){ return (maxWidthCh && maxWidthCh > 0) ? `${maxWidthCh}ch` : "Tela"; }
  function labelJustify(){ return justifyOn ? "J‚úì" : "J"; }
  function labelHyphen(){ return hyphenOn ? "Hy‚úì" : "Hy"; }

  function syncLayoutButtons(){
    if (btnFlow) btnFlow.textContent = labelFlow();
    if (btnSpread) {
      btnSpread.textContent = `Col ${labelSpread()}`;
      btnSpread.disabled = (flowMode !== "paginated");
    }
    if (btnMargin) btnMargin.textContent = labelMargin();
    if (btnWidth)  btnWidth.textContent = `L ${labelWidth()}`;
    if (btnJustify)btnJustify.textContent = labelJustify();
    if (btnHyphen) btnHyphen.textContent = labelHyphen();
  }

  function cycleValue(list, current){
    const i = list.indexOf(current);
    return list[(i >= 0 ? i + 1 : 0) % list.length];
  }

  function buildInjectedCss(){
    const night = document.body.classList.contains("night");
    const align = justifyOn ? "justify" : "start";
    const hy = hyphenOn ? "auto" : "manual";
    const pad = `${marginPx}px ${marginPx}px ${marginPx + 6}px ${marginPx}px`;
    const maxw = (maxWidthCh && maxWidthCh > 0) ? `${maxWidthCh}ch` : "none";
    const mx = (maxWidthCh && maxWidthCh > 0) ? "auto" : "0";
    const gap = `${columnGap}px`;

    return `
/* force langue: essentiel pour l'hyph√©nation CSS dans les navigateurs qui la supportent */
html{ -webkit-text-size-adjust:100%; }
html,body{ margin:0 !important; }
body{
  background:${night ? "#0f1115" : "#ffffff"} !important;
  color:${night ? "#e9edf1" : "#111111"} !important;
  line-height:1.65 !important;
  padding:${pad} !important;
  max-width:${maxw} !important;
  margin-left:${mx} !important;
  margin-right:${mx} !important;
  column-gap:${gap} !important;

  hyphens:${hy} !important;
  -webkit-hyphens:${hy} !important;
  -ms-hyphens:${hy} !important;

  overflow-wrap:break-word !important;
  word-break:normal !important;
}

a{ color:${night ? "#8ab4f8" : "#0b57d0"} !important; }

/* justification robuste */
p,li,blockquote,div,section,article{
  text-align:${align} !important;
  hyphens:${hy} !important;
  -webkit-hyphens:${hy} !important;
  -ms-hyphens:${hy} !important;
}
`;
  }

  function ensureHook(){
    if (!rendition || hookInstalled) return;
    hookInstalled = true;

    rendition.hooks.content.register((contents) => {
      try{
        const doc = contents.document;
        if (!doc) return;

        // PATCH hyphens: force lang=pt-BR si absent
        if (!doc.documentElement.getAttribute("lang")) doc.documentElement.setAttribute("lang","pt-BR");
        if (doc.body && !doc.body.getAttribute("lang")) doc.body.setAttribute("lang","pt-BR");

        let style = doc.getElementById("ccla-app-overrides");
        if (!style) {
          style = doc.createElement("style");
          style.id = "ccla-app-overrides";
          style.type = "text/css";
          (doc.head || doc.documentElement).appendChild(style);
        }
        style.textContent = injectedCss || "";
      } catch(e){}
    });
  }

  function refreshInjectedCss(){
    injectedCss = buildInjectedCss();
    if (!rendition) return;

    try{
      const views = rendition.views && rendition.views();
      if (views && views.forEach) {
        views.forEach(v => {
          try{
            const doc = v.document;
            if (!doc) return;

            if (!doc.documentElement.getAttribute("lang")) doc.documentElement.setAttribute("lang","pt-BR");
            if (doc.body && !doc.body.getAttribute("lang")) doc.body.setAttribute("lang","pt-BR");

            let style = doc.getElementById("ccla-app-overrides");
            if (!style) {
              style = doc.createElement("style");
              style.id = "ccla-app-overrides";
              style.type = "text/css";
              (doc.head || doc.documentElement).appendChild(style);
            }
            style.textContent = injectedCss;
          } catch(e){}
        });
      }
    } catch(e){}
  }

  function applyLayoutPrefs(){
    if (!rendition) return;

    // flow/spread
    try { rendition.flow(flowMode); } catch(e) {}
    const effectiveSpread = (flowMode === "paginated") ? spreadMode : "none";
    try { rendition.spread(effectiveSpread); } catch(e) {}

    persistLayoutPrefs();
    syncLayoutButtons();

    refreshInjectedCss();
    try { rendition.resize(); } catch(e) {}
  }

  function applyThemeToRendition(){
    if (!rendition) return;
    ensureHook();
    applyReadingPrefs();
    applyLayoutPrefs();
  }

  function setTheme(isNight) {
    document.body.classList.toggle("night", isNight);
    localStorage.setItem("theme", isNight ? "night" : "day");
    btnNight.textContent = isNight ? "‚òÄÔ∏è Dia" : "üåô Noite";
    btnNight.setAttribute("aria-label", isNight ? "Ativar modo dia" : "Ativar modo noite");
    applyThemeToRendition();
  }

  function initTheme() {
    const saved = localStorage.getItem("theme");
    setTheme(saved === "night");
    btnNight.addEventListener("click", () => setTheme(!document.body.classList.contains("night")));
  }

  function renderCatalog() {
    if (!elBooks) return;

    elBooks.innerHTML = BOOKS.map(b => `
      <div class="book">
        <div>
          <strong>${escapeHtml(b.title)}</strong>
          <small>${escapeHtml(b.author || "")}</small>
        </div>
        <button class="btn btn-primary" type="button" data-book="${escapeHtml(b.id)}">Ler</button>
      </div>
    `).join("");

    elBooks.querySelectorAll("button[data-book]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-book");
        const item = BOOKS.find(x => x.id === id);
        if (item) openBook(item);
      });
    });
  }

  function updateProgressUI(location){
    const displayed = location && location.start && location.start.displayed;
    const pagePart = (displayed && displayed.page && displayed.total)
      ? `P√°gina ${displayed.page} / ${displayed.total}`
      : "‚Äî";
    elProgress.textContent = pagePart;
  }

  // ===== FULLSCREEN =====
  function isFullscreen(){ return !!document.fullscreenElement; }

  function showFsExitTemporarily(){
    if (!btnFsExit) return;
    btnFsExit.classList.add("show");
    clearTimeout(showFsExitTemporarily._t);
    showFsExitTemporarily._t = setTimeout(() => btnFsExit.classList.remove("show"), 1800);
  }

  async function enterFullscreen(){
    if (!viewerShell) return;
    if (!document.fullscreenEnabled) return;
    try{ await viewerShell.requestFullscreen(); } catch(e){}
  }

  async function exitFullscreen(){
    try{ if (document.fullscreenElement) await document.exitFullscreen(); } catch(e){}
  }

  function toggleFullscreen(){
    if (isFullscreen()) exitFullscreen();
    else enterFullscreen();
  }

  document.addEventListener("fullscreenchange", () => {
    const fs = isFullscreen();
    document.body.classList.toggle("fs", fs);
    if (btnFs) btnFs.textContent = fs ? "‚§´" : "‚õ∂";
    if (fs) showFsExitTemporarily();
    else if (btnFsExit) btnFsExit.classList.remove("show");
  });

  ["mousemove","touchstart","click"].forEach(evt => {
    viewerShell && viewerShell.addEventListener(evt, () => {
      if (isFullscreen()) showFsExitTemporarily();
    }, {passive:true});
  });

  // ===== COVER-LOCK FIX (comme avant) =====
  function looksLikeCoverSpineItem(spineItem){
    if (!spineItem) return true;
    const href = String(spineItem.href || "").toLowerCase();
    const id = String(spineItem.idref || spineItem.id || "").toLowerCase();
    const props = String(spineItem.properties || "").toLowerCase();
    if (props.includes("cover")) return true;
    if (href.includes("cover")) return true;
    if (id.includes("cover")) return true;
    if (href.includes("titlepage") || id.includes("titlepage")) return true;
    return false;
  }

  function firstReadableSpineItem(){
    if (!book || !book.spine || !book.spine.items) return null;
    const items = book.spine.items;
    for (const it of items) {
      const linear = String(it.linear || "yes").toLowerCase();
      if (linear === "no") continue;
      if (looksLikeCoverSpineItem(it)) continue;
      return it;
    }
    for (const it of items) {
      const linear = String(it.linear || "yes").toLowerCase();
      if (linear === "no") continue;
      return it;
    }
    return items[0] || null;
  }

  async function displayFirstReadable(){
    const it = firstReadableSpineItem();
    if (!it || !rendition) return false;
    try{ await rendition.display(it.href); return true; }
    catch(e){ return false; }
  }

  // Nudge: ‚Äúr√©veille‚Äù certains EPUB qui n‚Äôaffichent qu‚Äôapr√®s next/prev
  async function nudgeRendition(){
    if (!rendition) return;
    try { rendition.resize(); } catch(e) {}
    await new Promise(r => setTimeout(r, 80));
    try { await rendition.next(); } catch(e) {}
    await new Promise(r => setTimeout(r, 80));
    try { await rendition.prev(); } catch(e) {}
    await new Promise(r => setTimeout(r, 80));
    try { rendition.resize(); } catch(e) {}
  }

  async function openBook(item) {
    clearError();
    hookInstalled = false;

    currentItem = item;
    readingSeconds = loadReadingTime(item);
    updateTimeUI();

    showReader();
    elTitle.textContent = item.title || "Livro";
    elProgress.textContent = "Carregando‚Ä¶";
    if (elSaveBadge) elSaveBadge.classList.remove("show");

    startReadingTimer();

    if (typeof window.ePub !== "function") {
      showError("N√£o consegui carregar o epub.js (epub.min.js).");
      return;
    }

    try {
      if (rendition) {
        try { rendition.destroy(); } catch(e) {}
        rendition = null;
      }
      book = null;

      const path = "epubs/" + item.file;
      const resp = await fetch(path);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const arrayBuffer = await resp.arrayBuffer();

      book = window.ePub(arrayBuffer);
      if (book.ready) await book.ready;

      rendition = book.renderTo("viewer", { width: "100%", height: "100%", spread: "none" });

      rendition.on("relocated", (location) => {
        savePosition(item, location);
        updateProgressUI(location);
      });

      // Applique ‚Äúcapabilities‚Äù du livre
      if (item.pagination === false) {
        flowMode = "scrolled-doc";
        spreadMode = "none";
        showNotice("‚ÑπÔ∏è Pagina√ß√£o desativada para este EPUB (inst√°vel). Modo rolagem ativado.");
      }

      // Handlers
      btnPrev.onclick = () => rendition && rendition.prev();
      btnNext.onclick = () => rendition && rendition.next();

      btnRestart.onclick = async () => {
        if (!currentItem || !rendition) return;
        clearPosition(currentItem);
        elProgress.textContent = "Carregando‚Ä¶";
        const ok = await displayFirstReadable();
        if (!ok) { try { await rendition.display(); } catch(e) {} }
        applyThemeToRendition();
        if (item.nudge) await nudgeRendition();
      };

      btnFontMinus.onclick = () => { fontPct = Math.max(80, fontPct - 10); applyReadingPrefs(); try{rendition.resize();}catch(e){} };
      btnFontPlus.onclick  = () => { fontPct = Math.min(200, fontPct + 10); applyReadingPrefs(); try{rendition.resize();}catch(e){} };

      btnFlow.onclick = () => {
        // si le livre ne supporte pas la pagination => pas de toggle
        if (item.pagination === false) return;
        flowMode = (flowMode === "paginated") ? "scrolled-doc" : "paginated";
        if (flowMode !== "paginated") spreadMode = "none";
        applyLayoutPrefs();
      };

      btnSpread.onclick = () => {
        if (flowMode !== "paginated") return;
        spreadMode = (spreadMode === "auto") ? "none" : "auto";
        applyLayoutPrefs();
      };

      btnMargin.onclick = () => { marginPx = cycleValue(MARGIN_STEPS, marginPx); applyLayoutPrefs(); };
      btnWidth.onclick  = () => { maxWidthCh = cycleValue(WIDTH_STEPS, maxWidthCh); applyLayoutPrefs(); };
      btnJustify.onclick= () => { justifyOn = !justifyOn; applyLayoutPrefs(); };
      btnHyphen.onclick = () => { hyphenOn = !hyphenOn; applyLayoutPrefs(); };

      // Display initial (retour lecture + cover-lock fix)
      const savedCfi = loadPosition(item);
      if (savedCfi) {
        await rendition.display(savedCfi);
      } else {
        const ok = await displayFirstReadable();
        if (!ok) await rendition.display();
      }

      applyThemeToRendition();
      syncLayoutButtons();

      // UI: d√©sactive vraiment les boutons de pagination si non support√©
      if (item.pagination === false) {
        btnFlow.disabled = true;
        btnSpread.disabled = true;
      } else {
        btnFlow.disabled = false;
        btnSpread.disabled = (flowMode !== "paginated");
      }

      // Nudge automatique pour MLS
      if (item.nudge) await nudgeRendition();

    } catch (err) {
      console.error(err);
      showError("Falha ao abrir o EPUB.\nDetalhe t√©cnico: " + (err && err.message ? err.message : String(err)));
      elProgress.textContent = "‚Äî";
    }
  }

  // Back
  btnBack.addEventListener("click", async () => {
    clearError();
    stopReadingTimer();
    if (isFullscreen()) await exitFullscreen();
    showCatalog();
  });

  // Fullscreen buttons
  if (btnFs) btnFs.addEventListener("click", toggleFullscreen);
  if (btnFsExit) btnFsExit.addEventListener("click", exitFullscreen);

  // Theme
  function initTheme() {
    const saved = localStorage.getItem("theme");
    setTheme(saved === "night");
    btnNight.addEventListener("click", () => setTheme(!document.body.classList.contains("night")));
  }

  function setTheme(isNight) {
    document.body.classList.toggle("night", isNight);
    localStorage.setItem("theme", isNight ? "night" : "day");
    btnNight.textContent = isNight ? "‚òÄÔ∏è Dia" : "üåô Noite";
    btnNight.setAttribute("aria-label", isNight ? "Ativar modo dia" : "Ativar modo noite");
    applyThemeToRendition();
  }

  initTheme();
  syncLayoutButtons();
  renderCatalog();

})();
</script>

</body>
</html>
