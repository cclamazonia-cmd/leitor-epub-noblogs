<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Biblioteca</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#ffffff;
  --fg:#111111;
  --muted:#666666;
  --card:#f5f5f5;
  --border:#dddddd;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#111111;
  --accentfg:#ffffff;

  --radius:16px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
  --font-ui:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  --font-reading:ui-serif,"Georgia","Times New Roman",Times,serif;

  /* ===== Catalogue background (fixed, not theme-dependent) ===== */
  --catalog-bg-url:url("https://cclamazonia.noblogs.org/files/2024/11/Arte-CCLA-paredao.jpg");

  /* ===== Reader watermark (same image, very subtle) ===== */
  --reader-watermark-opacity: .10;
}

body.night{
  --bg:#0f1115;
  --fg:#e9edf1;
  --muted:#a6b0bb;
  --card:#171a21;
  --border:#262b36;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#e9edf1;
  --accentfg:#0f1115;

  --shadow:0 12px 34px rgba(0,0,0,.35);

  /* Slightly different opacity at night so it's still subtle */
  --reader-watermark-opacity: .08;
}

*{box-sizing:border-box}
html,body{height:100%}

/* ===== Base page ===== */
body{
  margin:0;
  font-family:var(--font-ui);
  background:var(--bg);
  color:var(--fg);
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

/* ===== Catalogue-only background image (does NOT change with theme) ===== */
/* Default state = catalogue visible, reader closed */
body:not(.reader-open){
  background-image: var(--catalog-bg-url);
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

/* When reader is open: remove image and use theme background */
body.reader-open{
  background-image: none;
  background: var(--bg);
}

/* ===== Make catalogue readable on top of background image ===== */
body:not(.reader-open)::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  background: linear-gradient(
    to bottom,
    rgba(255,255,255,.72),
    rgba(255,255,255,.58)
  );
  pointer-events:none;
}

/* ===== Reader subtle watermark (light veil showing the same image) ===== */
body.reader-open::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  background-image: var(--catalog-bg-url);
  background-size: cover;
  background-position: center;
  background-repeat:no-repeat;
  background-attachment: fixed;
  opacity: var(--reader-watermark-opacity);
  filter: saturate(110%) contrast(105%);
}

/* Ensure app content stays above overlays */
header, main, footer{
  position:relative;
  z-index:1;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:color-mix(in srgb, var(--bg) 92%, transparent);
  backdrop-filter:saturate(140%) blur(8px);
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:12px;
}

/* Left: back-to-blog button */
.header-left{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  min-width:0;
}

/* Center: title */
.brand{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
  text-align:center;
}
header strong{
  font-size:18px;
  letter-spacing:.2px;
}
.tagline{
  font-size:13px;
  color:var(--muted);
}

/* Right: theme toggle */
.header-right{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  min-width:0;
}

.btn{
  padding:10px 12px;
  border:1px solid var(--border);
  background:var(--btnbg);
  color:var(--btnfg);
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  transition:transform .08s ease, background .15s ease, border-color .15s ease;
  user-select:none;
  white-space:nowrap;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn:hover{background:color-mix(in srgb, var(--card) 55%, var(--bg))}
.btn:active{transform:scale(.98)}
.btn:focus{outline:2px solid color-mix(in srgb, var(--accent) 35%, transparent);outline-offset:2px}

.btn-primary{
  border-color:transparent;
  background:var(--accent);
  color:var(--accentfg);
}

main{
  max-width:980px;
  margin:18px auto;
  padding:0 16px 24px;
}
body.reader-open main{max-width:min(1200px, 96vw)}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

h2{margin:0 0 8px 0;font-size:18px}
p{margin:0 0 12px 0;color:var(--muted);line-height:1.55}

/* ===== Catalogue (covers) ===== */
.book{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding:14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--bg);
  margin-bottom:12px;
}
.book-left{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:0;
}
.book-cover{
  height:60px;
  width:auto;
  flex:0 0 auto;
  display:block;
  border-radius:4px;
  border:1px solid color-mix(in srgb, var(--border) 80%, transparent);
  box-shadow:0 6px 16px rgba(0,0,0,.10);
  background:color-mix(in srgb, var(--card) 70%, var(--bg));
}
.book-cover-fallback{
  height:60px;
  width:42px;
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:4px;
  border:1px dashed var(--border);
  color:var(--muted);
  font-size:11px;
  padding:6px;
  text-align:center;
  line-height:1.1;
  background:color-mix(in srgb, var(--card) 70%, var(--bg));
}
.book-meta{min-width:0;}
.book strong{
  display:block;
  font-size:16px;
  letter-spacing:.2px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.book small{
  color:var(--muted);
  display:block;
  margin-top:2px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

@media (max-width:560px){
  header{
    grid-template-columns: auto 1fr auto;
  }
  header strong{font-size:16px;}
  .tagline{font-size:12px;}
  .book{align-items:flex-start;}
  .book strong,.book small{white-space:normal;}
}

/* ===== Reader ===== */
.reader-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

.reader-title{
  font-size:14px;
  color:var(--muted);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:70%;
}

.viewer{
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  background:var(--bg);
  position:relative;
}

/* ===== TOOLBAR (desktop default) ===== */
.viewer-toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--border);
  background:var(--card);
}

.viewer-left,.viewer-right{
  display:flex;
  align-items:center;
  gap:8px;
  min-width: 180px;
}
.viewer-left{justify-content:flex-start; flex-wrap:wrap}
.viewer-right{justify-content:flex-end; flex-wrap:wrap}

.viewer-center{
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:center;
  flex:1;
  flex-wrap:wrap;
}

.viewer-hint{
  color:var(--muted);
  font-size:13px;
  min-width: 180px;
  text-align:center;
}

.pill{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  white-space:nowrap;
}

.save-badge{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  opacity:0;
  transform:translateY(2px);
  transition:opacity .18s ease, transform .18s ease;
  white-space:nowrap;
}
.save-badge.show{opacity:1;transform:translateY(0)}

/* ===== Mobile improvements: toolbar fully accessible ===== */
@media (max-width:760px){
  /* Bigger tap targets */
  .btn{ padding:12px 12px; }

  /* Toolbar becomes 2 rows and remains scrollable if needed */
  .viewer-toolbar{
    flex-wrap:wrap;
    gap:8px;
    padding:8px;
  }

  .viewer-left,
  .viewer-center,
  .viewer-right{
    min-width:0;
    flex:1 1 100%;
    justify-content:flex-start;
    flex-wrap:nowrap;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none; /* Firefox */
    gap:8px;
    padding-bottom:2px;
  }
  .viewer-left::-webkit-scrollbar,
  .viewer-center::-webkit-scrollbar,
  .viewer-right::-webkit-scrollbar{
    display:none; /* Chrome/Safari */
  }

  /* Keep groups in sensible order */
  .viewer-left{ order:1; }
  .viewer-center{ order:2; justify-content:space-between; }
  .viewer-right{ order:3; justify-content:flex-end; }

  /* Progress text stays readable but can shrink */
  .viewer-hint{
    min-width:0;
    flex:1 1 auto;
    font-size:12px;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
}

/* Extra-small phones: hide non-essential badges to keep buttons visible */
@media (max-width:420px){
  #saveBadge{ display:none; }
  #timePill{ display:none; }
}

#viewer{
  width:100%;
  height: calc(100vh - 230px);
  background:var(--bg);
}

/* Fullscreen */
.fullscreen-exit{
  position:absolute;
  top:10px;
  right:10px;
  z-index:50;
  display:none;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:color-mix(in srgb, var(--bg) 85%, var(--card));
  color:var(--fg);
  cursor:pointer;
  font-size:14px;
  box-shadow:var(--shadow);
  opacity:0;
  transform:translateY(-2px);
  transition:opacity .18s ease, transform .18s ease;
}
.fullscreen-exit.show{opacity:1;transform:translateY(0)}

.viewer:fullscreen{
  border-radius:0;
  border:0;
  width:100vw;
  height:100vh;
  background:var(--bg);
}
.viewer:fullscreen #viewer{height: calc(100vh - 64px);}
.viewer:fullscreen .fullscreen-exit{
  display:inline-flex;
  align-items:center;
  gap:8px;
}

body.fs header{display:none}
body.fs main{margin:0; padding:0}
body.fs .card{border-radius:0; box-shadow:none; margin:0; padding:0; border:0}
body.fs .reader-top{display:none}

.notice{
  margin-top:10px;
  padding:10px;
  border:1px dashed var(--border);
  border-radius:12px;
  color:var(--muted);
  background:color-mix(in srgb, var(--card) 75%, var(--bg));
}

.footer{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:28px 16px 40px;
}
.footer-logo{max-height:150px;width:auto;display:block}
body.reader-open .footer{display:none}

/* =========================================================
   Reader UI ‚Äî enhanced visibility (PC + mobile, day/night)
   (Override only, no JS/HTML changes)
   ========================================================= */

:root{
  --ui-surface: color-mix(in srgb, var(--card) 86%, transparent);
  --ui-surface-strong: color-mix(in srgb, var(--card) 94%, var(--bg));
  --ui-border: color-mix(in srgb, var(--border) 70%, transparent);
  --ui-shadow: 0 10px 26px rgba(0,0,0,.10);

  --ui-btn-bg: color-mix(in srgb, var(--bg) 72%, var(--card));
  --ui-btn-bg-hover: color-mix(in srgb, var(--bg) 60%, var(--card));
  --ui-btn-border: color-mix(in srgb, var(--border) 85%, transparent);

  --ui-btn-fg: var(--fg);
  --ui-btn-fg-muted: color-mix(in srgb, var(--fg) 70%, var(--muted));

  --ui-btn-radius: 14px;
  --ui-btn-height: 42px;
}

body.night{
  --ui-shadow: 0 14px 30px rgba(0,0,0,.40);
  --ui-btn-bg: color-mix(in srgb, var(--bg) 58%, var(--card));
  --ui-btn-bg-hover: color-mix(in srgb, var(--bg) 45%, var(--card));
}

/* Un peu plus de pr√©sence pour le viewer */
.viewer{
  box-shadow: var(--ui-shadow);
}

/* Toolbar sticky pour rester accessible pendant lecture */
.viewer-toolbar{
  position: sticky;
  top: 0;
  z-index: 5;
  background: var(--ui-surface);
  backdrop-filter: blur(10px) saturate(140%);
  border-bottom: 1px solid var(--ui-border);
}

/* Boutons de la toolbar : plus visibles (sans impacter le reste du site) */
.viewer-toolbar .btn{
  border: 1px solid var(--ui-btn-border);
  background: var(--ui-btn-bg);
  color: var(--ui-btn-fg);
  height: var(--ui-btn-height);
  padding: 0 12px;
  border-radius: var(--ui-btn-radius);
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
  font-weight: 700;
  letter-spacing: .2px;
}

/* Hover/active plus nets */
.viewer-toolbar .btn:hover{
  background: var(--ui-btn-bg-hover);
  border-color: color-mix(in srgb, var(--accent) 22%, var(--ui-btn-border));
}
.viewer-toolbar .btn:active{
  transform: translateY(1px) scale(.99);
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
}

/* Fl√®ches / fullscreen un peu plus lisibles */
#prevBtn, #nextBtn, #fsBtn{
  font-size:16px;
}

/* Progress "pill" centrale plus lisible */
.viewer-hint{
  font-weight: 800;
  color: var(--fg);
  background: var(--ui-surface-strong);
  border: 1px solid var(--ui-border);
  border-radius: 999px;
  padding: 8px 12px;
  min-width: unset;
  box-shadow: 0 6px 16px rgba(0,0,0,.06);
}

/* Time + badge : meilleur contraste */
.pill, .save-badge{
  background: var(--ui-surface-strong);
  border: 1px solid var(--ui-border);
  color: var(--ui-btn-fg-muted);
  font-weight: 700;
}

/* Spacing un poil plus confortable */
.viewer-left, .viewer-center, .viewer-right{
  gap: 10px;
}

/* Zone lecture : fond l√©g√®rement adouci */
#viewer{
  background: color-mix(in srgb, var(--bg) 92%, transparent);
}

/* Mobile : un chou√Øa plus compact sans perdre la lisibilit√© */
@media (max-width:560px){
  :root{ --ui-btn-height: 40px; }

  .viewer-toolbar{
    gap:8px;
    padding:10px 10px;
  }

  .viewer-left, .viewer-right{
    min-width: unset;
  }

  .viewer-hint{
    font-size:12px;
    padding:7px 10px;
  }

  #restartBtn{
    padding: 0 10px;
    font-weight: 800;
  }

  .pill{
    font-size:11px;
    padding:6px 8px;
  }
}

/* Focus accessibilit√© : tr√®s visible */
.viewer-toolbar .btn:focus{
  outline: 3px solid color-mix(in srgb, var(--accent) 38%, transparent);
  outline-offset: 2px;
}
</style>
</head>

<body>
<header>
  <div class="header-left">
    <a class="btn" id="backBlogBtn"
       href="https://cclamazonia.noblogs.org/editora-ccla-um-espaco-livre-para-ler-pensar-e-compartilhar/"
       title="Voltar ao blogue"
       aria-label="Voltar ao blogue">
      ‚Üê Blogue
    </a>
  </div>

  <div class="brand" aria-label="Biblioteca ‚Ä¢ Leitor EPUB ‚Ä¢ Editora CCLA">
    <strong>Biblioteca</strong>
    <span class="tagline">Leitor EPUB ‚Ä¢ Editora CCLA</span>
  </div>

  <div class="header-right">
    <button class="btn" id="toggleNight" type="button" aria-label="Alternar tema" title="Alternar tema">üåô Noite</button>
  </div>
</header>

<main>
  <section id="catalogo" class="card">
    <h2>Cat√°logo</h2>
    <p>Escolha um livro para abrir no leitor.</p>
    <div id="books"></div>
  </section>

  <section id="leitor" class="card" style="display:none;">
    <div class="reader-top">
      <button class="btn" id="backBtn" type="button" title="Voltar ao cat√°logo">‚Üê Cat√°logo</button>
      <div class="reader-title" id="bookTitle">Carregando‚Ä¶</div>
    </div>

    <div class="viewer" id="viewerShell">
      <div class="viewer-toolbar">
        <div class="viewer-left">
          <button class="btn" id="prevBtn" type="button" aria-label="P√°gina anterior" title="P√°gina anterior">‚Üê</button>
          <button class="btn" id="restartBtn" type="button" aria-label="Recome√ßar do in√≠cio" title="Recome√ßar do in√≠cio">Recome√ßar</button>
          <button class="btn" id="fsBtn" type="button" aria-label="Tela cheia" title="Tela cheia">‚õ∂</button>
        </div>

        <div class="viewer-center">
          <button class="btn" id="fontMinus" type="button" aria-label="Diminuir fonte" title="Diminuir fonte">A‚àí</button>
          <div class="viewer-hint" id="progress">‚Äî</div>
          <button class="btn" id="fontPlus" type="button" aria-label="Aumentar fonte" title="Aumentar fonte">A+</button>
        </div>

        <div class="viewer-right">
          <button class="btn" id="justifyBtn" type="button" aria-label="Justifica√ß√£o" title="Alternar justifica√ß√£o">J</button>
          <button class="btn" id="hyphenBtn" type="button" aria-label="Hifeniza√ß√£o" title="Alternar hifeniza√ß√£o">Hy</button>

          <span class="pill" id="timePill" aria-label="Tempo de leitura">Tempo: 00:00</span>
          <span class="save-badge" id="saveBadge" aria-live="polite">√öltima leitura salva ‚úÖ</span>
          <button class="btn" id="nextBtn" type="button" aria-label="Pr√≥xima p√°gina" title="Pr√≥xima p√°gina">‚Üí</button>
        </div>
      </div>

      <button class="fullscreen-exit" id="fsExitBtn" type="button" aria-label="Sair da tela cheia" title="Sair da tela cheia">‚§´ Sair</button>
      <div id="viewer" aria-label="√Årea de leitura"></div>
    </div>

    <div id="errorBox" class="notice" style="display:none;"></div>
  </section>
</main>

<footer class="footer" aria-label="Editora CCLA">
  <img class="footer-logo" src="assets/logo/ccla_editora.png" alt="Editora CCLA">
</footer>

<script src="jszip.min.js"></script>
<script src="epub.min.js"></script>
<script>
(() => {
  "use strict";

  // ====== CONFIG ======
  const BOOKS = [
    { id: "extrativismo", title: "Extrativismo", author: "Anna Bednik e J√©r√©my Dotti", file: "extrativismo-def.epub", cover: "assets/covers/capa-extrativismo.jpg" },
    { id: "geografia-libertaria", title: "Por uma Geografia libert√°ria", author: "Marcelo Lopes de Souza", file: "mls.epub", cover: "assets/covers/capa-mls.jpg" }
  ];

  // ====== DOM ======
  const elCatalogo = document.getElementById("catalogo");
  const elLeitor = document.getElementById("leitor");
  const elBooks = document.getElementById("books");
  const elTitle = document.getElementById("bookTitle");
  const elProgress = document.getElementById("progress");
  const elError = document.getElementById("errorBox");
  const elSaveBadge = document.getElementById("saveBadge");
  const elTimePill = document.getElementById("timePill");

  const btnNight = document.getElementById("toggleNight");
  const btnBack = document.getElementById("backBtn");
  const btnPrev = document.getElementById("prevBtn");
  const btnNext = document.getElementById("nextBtn");
  const btnRestart = document.getElementById("restartBtn");
  const btnFontMinus = document.getElementById("fontMinus");
  const btnFontPlus  = document.getElementById("fontPlus");
  const btnJustify   = document.getElementById("justifyBtn");
  const btnHyphen    = document.getElementById("hyphenBtn");

  // Fullscreen
  const viewerShell = document.getElementById("viewerShell");
  const btnFs = document.getElementById("fsBtn");
  const btnFsExit = document.getElementById("fsExitBtn");

  // ====== STATE ======
  let book = null;
  let rendition = null;
  let currentItem = null;

  let fontPct = Number(localStorage.getItem("fontPct") || 110);
  let saveBadgeTimer = null;
  let locReadyPromise = Promise.resolve(false);

  let justifyOn = (localStorage.getItem("justifyOn") || "0") === "1";
  let hyphenOn  = (localStorage.getItem("hyphenOn")  || "1") === "1";

  // Mode fix√© : pages (horizontal) uniquement
  const FLOW_MODE = "paginated";

  // Hooks (par rendition)
  let langHookInstalled = false;
  let hardCssHookInstalled = false;

  // ====== TIMER ======
  let readingSeconds = 0;
  let rafId = null;
  let lastTs = null;
  let carryMs = 0;
  const CHUNK_MS = 30000;

  // ====== UTIL ======
  function escapeHtml(value) {
    return String(value ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function showError(message) {
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function showNotice(message){
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function clearError() {
    elError.style.display = "none";
    elError.textContent = "";
  }

  function showReader() {
    elCatalogo.style.display = "none";
    elLeitor.style.display = "block";
    document.body.classList.add("reader-open");
  }

  function showCatalog() {
    elLeitor.style.display = "none";
    elCatalogo.style.display = "block";
    document.body.classList.remove("reader-open");
  }

  function showSavedBadge() {
    if (!elSaveBadge) return;
    elSaveBadge.classList.add("show");
    if (saveBadgeTimer) clearTimeout(saveBadgeTimer);
    saveBadgeTimer = setTimeout(() => elSaveBadge.classList.remove("show"), 1400);
  }

  // ====== STORAGE KEYS ======
  function storageKeyForBook(item) { return "pos:" + (item && item.id ? item.id : "unknown"); }
  function timeKeyForBook(item)    { return "time:" + (item && item.id ? item.id : "unknown"); }
  function locKeyForBook(item)     { return "loc:" + (item && item.id ? item.id : "unknown"); }

  // ====== POSITION SAVE/LOAD (CFI) ======
  function savePosition(item, location) {
    try {
      const cfi = location && location.start && location.start.cfi;
      if (!cfi) return;
      localStorage.setItem(storageKeyForBook(item), cfi);
      showSavedBadge();
    } catch(e) {}
  }
  function loadPosition(item) {
    try { return localStorage.getItem(storageKeyForBook(item)); }
    catch(e){ return null; }
  }
  function clearPosition(item) {
    try { localStorage.removeItem(storageKeyForBook(item)); }
    catch(e){}
  }

  // ====== LOCATIONS (for % progress) ======
  async function ensureLocations(item){
    if (!book || !book.locations) return false;
    try {
      if (book.ready) await book.ready;
      if (typeof book.locations.length === "function" && book.locations.length() > 0) return true;

      const saved = localStorage.getItem(locKeyForBook(item));
      if (saved) {
        book.locations.load(saved);
        if (book.locations.length() > 0) return true;
      }

      await book.locations.generate(1024);

      try { localStorage.setItem(locKeyForBook(item), book.locations.save()); } catch(e) {}
      return (typeof book.locations.length === "function" && book.locations.length() > 0);
    } catch(e) {
      return false;
    }
  }

  function percentFromLocation(location){
    const displayed = location && location.start && location.start.displayed;

    const p = location && location.start && location.start.percentage;
    if (typeof p === "number" && isFinite(p)) {
      const pp = Math.max(0, Math.min(1, p));
      if (!(displayed && displayed.page && displayed.total && displayed.page < displayed.total && pp > 0.99)) {
        return pp;
      }
    }

    const cfi = location && location.start && location.start.cfi;
    if (!cfi || !book || !book.locations || typeof book.locations.length !== "function") return null;
    if (book.locations.length() === 0) return null;

    if (typeof book.locations.percentageFromCfi === "function") {
      const px = book.locations.percentageFromCfi(cfi);
      if (typeof px === "number" && isFinite(px)) {
        const pp = Math.max(0, Math.min(1, px));
        if (displayed && displayed.page && displayed.total && displayed.page < displayed.total && pp > 0.99) return null;
        return pp;
      }
    }
    return null;
  }

  // ====== TIMER (rAF) ======
  function isReadingActive(){
    return document.body.classList.contains("reader-open")
      && document.visibilityState === "visible"
      && !!currentItem;
  }

  function loadReadingTime(item){
    try {
      const v = Number(localStorage.getItem(timeKeyForBook(item)) || 0);
      return Number.isFinite(v) && v >= 0 ? v : 0;
    } catch(e){ return 0; }
  }

  function saveReadingTime(item){
    try { localStorage.setItem(timeKeyForBook(item), String(readingSeconds)); } catch(e){}
  }

  function formatTime(sec){
    const s = Math.max(0, Math.floor(sec));
    const mm = Math.floor(s / 60);
    const ss = s % 60;
    return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
  }

  function updateTimeUI(){
    if (!elTimePill) return;
    elTimePill.textContent = `Tempo: ${formatTime(readingSeconds)}`;
  }

  function commitChunks(){
    const chunks = Math.floor(carryMs / CHUNK_MS);
    if (chunks > 0) {
      readingSeconds += chunks * 30;
      carryMs -= chunks * CHUNK_MS;
      if (currentItem) saveReadingTime(currentItem);
      updateTimeUI();
    }
  }

  function rafLoop(ts){
    if (lastTs === null) lastTs = ts;
    let dt = ts - lastTs;
    lastTs = ts;

    if (!Number.isFinite(dt) || dt < 0) dt = 0;
    if (dt > 5000) dt = 0;

    if (isReadingActive()) {
      carryMs += dt;
      commitChunks();
    }
    rafId = requestAnimationFrame(rafLoop);
  }

  function startReadingTimer(){
    stopReadingTimer();
    carryMs = 0;
    lastTs = null;
    updateTimeUI();
    rafId = requestAnimationFrame(rafLoop);
  }

  function stopReadingTimer(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    commitChunks();
    carryMs = 0;
    lastTs = null;
  }

  document.addEventListener("visibilitychange", () => {
    lastTs = null;
    updateTimeUI();
  });

  window.addEventListener("pagehide", () => {
    if (currentItem) saveReadingTime(currentItem);
  });

  // ====== READING PREFS ======
  function applyReadingPrefs() {
    if (!rendition) return;
    try {
      rendition.themes.fontSize(fontPct + "%");
      localStorage.setItem("fontPct", String(fontPct));
    } catch(e) {}
  }

  function syncJustifyHyphenButtons(){
    if (btnJustify) btnJustify.textContent = justifyOn ? "J‚úì" : "J";
    if (btnHyphen)  btnHyphen.textContent  = hyphenOn  ? "Hy‚úì" : "Hy";
  }

  // ====== HARD CSS OVERRIDE (fix EPUB forcing black text) ======
  const HARD_STYLE_ID = "ccla-hard-override-style";

  function hardCssText(night){
    const bg = night ? "#0f1115" : "#ffffff";
    const fg = night ? "#e9edf1" : "#111111";
    const link = night ? "#8ab4f8" : "#0b57d0";
    const align = justifyOn ? "justify" : "start";
    const hy = hyphenOn ? "auto" : "manual";

    return `
html, body {
  background: ${bg} !important;
  color: ${fg} !important;
}

* {
  color: inherit !important;
  background-color: transparent !important;
  text-shadow: none !important;
}

a, a:visited { color: ${link} !important; }

p, li, blockquote, div, section, article {
  text-align: ${align} !important;
  hyphens: ${hy} !important;
  -webkit-hyphens: ${hy} !important;
  -ms-hyphens: ${hy} !important;
  line-height: 1.65 !important;
}

body {
  padding: 18px 18px 24px 18px !important;
  margin: 0 !important;
}

img, svg, video, canvas {
  background: transparent !important;
}

table, thead, tbody, tr, td, th {
  background: transparent !important;
}
`.trim();
  }

  function upsertHardStyle(contents, night){
    try{
      const doc = contents && contents.document;
      if (!doc) return;

      let styleEl = doc.getElementById(HARD_STYLE_ID);
      if (!styleEl) {
        styleEl = doc.createElement("style");
        styleEl.id = HARD_STYLE_ID;
        styleEl.type = "text/css";
        (doc.head || doc.documentElement).appendChild(styleEl);
      }
      styleEl.textContent = hardCssText(night);
    } catch(e){}
  }

  function updateAllContentsHardStyle(){
    if (!rendition) return;
    const night = document.body.classList.contains("night");
    try{
      const list = (typeof rendition.getContents === "function") ? rendition.getContents() : [];
      for (const c of list) upsertHardStyle(c, night);
    } catch(e){}
  }

  function ensureHooks(){
    if (!rendition) return;

    if (!langHookInstalled) {
      langHookInstalled = true;
      try {
        rendition.hooks.content.register((contents) => {
          try {
            const doc = contents.document;
            if (!doc) return;
            if (!doc.documentElement.getAttribute("lang")) doc.documentElement.setAttribute("lang","pt-BR");
            if (doc.body && !doc.body.getAttribute("lang")) doc.body.setAttribute("lang","pt-BR");
          } catch(e){}
        });
      } catch(e){}
    }

    if (!hardCssHookInstalled) {
      hardCssHookInstalled = true;
      try {
        rendition.hooks.content.register((contents) => {
          const night = document.body.classList.contains("night");
          upsertHardStyle(contents, night);
        });
      } catch(e){}
    }
  }

  // ====== THEME ======
  function applyThemeToRendition() {
    if (!rendition) return;

    ensureHooks();

    const night = document.body.classList.contains("night");
    rendition.themes.register("app", {
      "a": { "color": night ? "#8ab4f8" : "#0b57d0" }
    });
    rendition.themes.select("app");

    applyReadingPrefs();
    syncJustifyHyphenButtons();
    updateAllContentsHardStyle();

    try { localStorage.setItem("justifyOn", justifyOn ? "1" : "0"); } catch(e) {}
    try { localStorage.setItem("hyphenOn",  hyphenOn  ? "1" : "0"); } catch(e) {}
  }

  function setTheme(isNight) {
    document.body.classList.toggle("night", isNight);
    localStorage.setItem("theme", isNight ? "night" : "day");
    btnNight.textContent = isNight ? "‚òÄÔ∏è Dia" : "üåô Noite";
    btnNight.setAttribute("aria-label", isNight ? "Ativar modo dia" : "Ativar modo noite");
    applyThemeToRendition();
  }

  function initTheme() {
    const saved = localStorage.getItem("theme");
    setTheme(saved === "night");
    btnNight.addEventListener("click", () => setTheme(!document.body.classList.contains("night")));
  }

  // ===== FULLSCREEN =====
  function isFullscreen(){ return !!document.fullscreenElement; }

  function showFsExitTemporarily(){
    if (!btnFsExit) return;
    btnFsExit.classList.add("show");
    clearTimeout(showFsExitTemporarily._t);
    showFsExitTemporarily._t = setTimeout(() => btnFsExit.classList.remove("show"), 1800);
  }

  async function enterFullscreen(){
    if (!viewerShell) return;
    if (!document.fullscreenEnabled) return;
    try{ await viewerShell.requestFullscreen(); } catch(e){}
  }

  async function exitFullscreen(){
    try{ if (document.fullscreenElement) await document.exitFullscreen(); } catch(e){}
  }

  function toggleFullscreen(){
    if (isFullscreen()) exitFullscreen();
    else enterFullscreen();
  }

  document.addEventListener("fullscreenchange", () => {
    const fs = isFullscreen();
    document.body.classList.toggle("fs", fs);
    if (btnFs) btnFs.textContent = fs ? "‚§´" : "‚õ∂";
    if (fs) showFsExitTemporarily();
    else if (btnFsExit) btnFsExit.classList.remove("show");
    try { rendition && rendition.resize(); } catch(e){}
  });

  ["mousemove","touchstart","click"].forEach(evt => {
    viewerShell && viewerShell.addEventListener(evt, () => {
      if (isFullscreen()) showFsExitTemporarily();
    }, {passive:true});
  });

  // ====== UI ======
  function coverHtml(b){
    if (!b.cover) {
      return `<div class="book-cover-fallback" aria-hidden="true">sem<br>capa</div>`;
    }
    return `
      <img
        class="book-cover"
        src="${escapeHtml(b.cover)}"
        alt="Capa ‚Äì ${escapeHtml(b.title)}"
        loading="lazy"
        onerror="this.outerHTML='<div class=&quot;book-cover-fallback&quot; aria-hidden=&quot;true&quot;>sem<br>capa</div>'"
      >
    `;
  }

  function renderCatalog() {
    if (!elBooks) return;

    if (!Array.isArray(BOOKS) || BOOKS.length === 0) {
      elBooks.innerHTML = `
        <div class="notice">
          Nenhum livro configurado.<br>
          Adicione arquivos <code>.epub</code> em <code>epubs/</code> e atualize a lista no c√≥digo.
        </div>
      `;
      return;
    }

    elBooks.innerHTML = BOOKS.map(b => `
      <div class="book">
        <div class="book-left">
          ${coverHtml(b)}
          <div class="book-meta">
            <strong>${escapeHtml(b.title)}</strong>
            <small>${escapeHtml(b.author || "")}</small>
          </div>
        </div>
        <button class="btn btn-primary" type="button" data-book="${escapeHtml(b.id)}">Ler</button>
      </div>
    `).join("");

    elBooks.querySelectorAll("button[data-book]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-book");
        const item = BOOKS.find(x => x.id === id);
        if (item) openBook(item);
      });
    });
  }

  function updateProgressUI(location){
    const displayed = location && location.start && location.start.displayed;

    const percent = (function(){
      const p = location && location.start && location.start.percentage;
      if (typeof p === "number" && isFinite(p)) {
        const pp = Math.max(0, Math.min(1, p));
        if (!(displayed && displayed.page && displayed.total && displayed.page < displayed.total && pp > 0.99)) return pp;
      }
      const cfi = location && location.start && location.start.cfi;
      if (!cfi || !book || !book.locations || typeof book.locations.length !== "function") return null;
      if (book.locations.length() === 0) return null;
      if (typeof book.locations.percentageFromCfi === "function") {
        const px = book.locations.percentageFromCfi(cfi);
        if (typeof px === "number" && isFinite(px)) {
          const pp = Math.max(0, Math.min(1, px));
          if (displayed && displayed.page && displayed.total && displayed.page < displayed.total && pp > 0.99) return null;
          return pp;
        }
      }
      return null;
    })();

    const pagePart = (displayed && displayed.page && displayed.total)
      ? `P√°gina ${displayed.page} / ${displayed.total}`
      : "‚Äî";

    const pctPart = (percent !== null)
      ? ` ‚Ä¢ ${Math.round(percent * 100)}%`
      : "";

    elProgress.textContent = pagePart + pctPart;
  }

  // ====== REPRISE (TOC / SPINE) ======
  async function displayFromTOCOrSpine(){
    try {
      if (book && book.navigation && Array.isArray(book.navigation.toc) && book.navigation.toc.length) {
        const toc = book.navigation.toc;
        const first = toc.find(t => t && t.href) || null;
        if (first && first.href) { await rendition.display(first.href); return true; }
      }
    } catch(e) {}

    try {
      const items = book && book.spine && book.spine.items ? book.spine.items : null;
      if (items && items.length) {
        for (const it of items) {
          const linear = String(it.linear || "yes").toLowerCase();
          if (linear === "no") continue;
          const href = it.href || "";
          if (!href) continue;
          try { await rendition.display(href); return true; } catch(e){}
        }
      }
    } catch(e) {}

    try { await rendition.display(); return true; } catch(e) {}
    return false;
  }

  async function applyFlowPaginated(keepLocation = true){
    if (!rendition) return;

    let cfi = null;
    if (keepLocation) {
      try {
        const loc = rendition.currentLocation && rendition.currentLocation();
        cfi = loc && loc.start && loc.start.cfi ? loc.start.cfi : null;
      } catch(e){}
    }

    try { rendition.spread("none"); } catch(e){}
    try { rendition.flow(FLOW_MODE); } catch(e){}

    try { if (cfi) await rendition.display(cfi); } catch(e){}
    try { rendition.resize(); } catch(e){}
  }

  // ====== EPUB ======
  async function openBook(item) {
    clearError();

    currentItem = item;
    readingSeconds = loadReadingTime(item);
    updateTimeUI();

    showReader();
    elTitle.textContent = item.title || "Livro";

    const savedCfi = loadPosition(item);
    elProgress.textContent = savedCfi ? "Retomando‚Ä¶" : "Carregando‚Ä¶";
    if (elSaveBadge) elSaveBadge.classList.remove("show");

    startReadingTimer();

    if (typeof window.ePub !== "function") {
      showError(
        "N√£o consegui carregar o epub.js.\n" +
        "Verifique se existe o arquivo: epub.min.js\n" +
        "na mesma pasta do arquivo HTML."
      );
      elProgress.textContent = "‚Äî";
      return;
    }

    try {
      if (rendition) {
        try { rendition.destroy(); } catch(e) {}
        rendition = null;
      }
      book = null;

      langHookInstalled = false;
      hardCssHookInstalled = false;

      const path = "epubs/" + item.file;

      const resp = await fetch(path);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const arrayBuffer = await resp.arrayBuffer();

      book = window.ePub(arrayBuffer);

      locReadyPromise = (book.ready ? book.ready.then(() => ensureLocations(item)) : ensureLocations(item));

      rendition = book.renderTo("viewer", { width: "100%", height: "100%", spread: "none" });

      applyThemeToRendition();
      await applyFlowPaginated(false);

      btnPrev.onclick = () => rendition && rendition.prev();
      btnNext.onclick = () => rendition && rendition.next();

      btnRestart.onclick = async () => {
        if (!currentItem || !rendition) return;
        clearPosition(currentItem);
        elProgress.textContent = "Carregando‚Ä¶";
        try { await displayFromTOCOrSpine(); } catch(e){}
        applyThemeToRendition();
        await applyFlowPaginated(true);
      };

      btnFontMinus.onclick = () => { fontPct = Math.max(80, fontPct - 10); applyReadingPrefs(); };
      btnFontPlus.onclick  = () => { fontPct = Math.min(200, fontPct + 10); applyReadingPrefs(); };

      btnJustify.onclick = () => { justifyOn = !justifyOn; applyThemeToRendition(); };
      btnHyphen.onclick  = () => { hyphenOn  = !hyphenOn;  applyThemeToRendition(); };

      if (btnFs) btnFs.onclick = toggleFullscreen;
      if (btnFsExit) btnFsExit.onclick = exitFullscreen;

      rendition.on("relocated", (location) => {
        savePosition(item, location);
        updateProgressUI(location);
      });

      rendition.on("rendered", () => {
        applyThemeToRendition();
      });

      if (savedCfi) {
        try { await rendition.display(savedCfi); }
        catch(e) {
          clearPosition(item);
          showNotice("‚ÑπÔ∏è Posi√ß√£o salva incompat√≠vel com a nova vers√£o do EPUB. Abrindo no in√≠cio‚Ä¶");
          await displayFromTOCOrSpine();
        }
      } else {
        const ok = await displayFromTOCOrSpine();
        if (!ok) { try { await rendition.display(); } catch(e){} }
      }

      applyThemeToRendition();
      await applyFlowPaginated(true);

      try {
        await locReadyPromise;
        const loc = rendition && rendition.currentLocation ? rendition.currentLocation() : null;
        if (loc) updateProgressUI(loc);
      } catch(e) {}

    } catch (err) {
      console.error(err);
      showError(
        "Falha ao abrir o EPUB.\n" +
        "Detalhe t√©cnico: " + (err && err.message ? err.message : String(err))
      );
      elProgress.textContent = "‚Äî";
    }
  }

  btnBack.addEventListener("click", async () => {
    clearError();
    stopReadingTimer();
    if (isFullscreen()) await exitFullscreen();
    showCatalog();
  });

  document.addEventListener("keydown", (e) => {
    if (!rendition) return;
    if (e.key === "ArrowLeft") { e.preventDefault(); try{ rendition.prev(); } catch(_e){} }
    if (e.key === "ArrowRight"){ e.preventDefault(); try{ rendition.next(); } catch(_e){} }
  });

  initTheme();
  syncJustifyHyphenButtons();
  renderCatalog();
})();
</script>

</body>
</html>
