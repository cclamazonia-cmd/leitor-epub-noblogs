<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Biblioteca</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#ffffff;
  --fg:#111111;
  --muted:#666666;
  --card:#f5f5f5;
  --border:#dddddd;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#111111;
  --accentfg:#ffffff;

  --radius:16px;
  --shadow:0 10px 30px rgba(0,0,0,.08);
  --font-ui:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  --font-reading:ui-serif,"Georgia","Times New Roman",Times,serif;
}

body.night{
  --bg:#0f1115;
  --fg:#e9edf1;
  --muted:#a6b0bb;
  --card:#171a21;
  --border:#262b36;
  --btnbg:transparent;
  --btnfg:var(--fg);
  --accent:#e9edf1;
  --accentfg:#0f1115;

  --shadow:0 12px 34px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:var(--font-ui);
  background:var(--bg);
  color:var(--fg);
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

header{
  position:sticky;
  top:0;
  z-index:10;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:color-mix(in srgb, var(--bg) 92%, transparent);
  backdrop-filter:saturate(140%) blur(8px);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

.brand{display:flex;flex-direction:column;gap:2px}
header strong{font-size:16px;letter-spacing:.2px}
.tagline{font-size:12px;color:var(--muted)}

.btn{
  padding:10px 12px;
  border:1px solid var(--border);
  background:var(--btnbg);
  color:var(--btnfg);
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  transition:transform .08s ease, background .15s ease, border-color .15s ease;
  user-select:none;
  white-space:nowrap;
}
.btn:hover{background:color-mix(in srgb, var(--card) 55%, var(--bg))}
.btn:active{transform:scale(.98)}
.btn:focus{outline:2px solid color-mix(in srgb, var(--accent) 35%, transparent);outline-offset:2px}

.btn-primary{
  border-color:transparent;
  background:var(--accent);
  color:var(--accentfg);
}

main{
  max-width:980px;
  margin:18px auto;
  padding:0 16px 24px;
}
body.reader-open main{max-width:min(1200px, 96vw)}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

h2{margin:0 0 8px 0;font-size:18px}
p{margin:0 0 12px 0;color:var(--muted);line-height:1.55}

/* ===== Catalogue (covers) ===== */
.book{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding:14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--bg);
  margin-bottom:12px;
}
.book-left{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:0;
}
.book-cover{
  height:60px;
  width:auto;
  flex:0 0 auto;
  display:block;
  border-radius:4px;
  border:1px solid color-mix(in srgb, var(--border) 80%, transparent);
  box-shadow:0 6px 16px rgba(0,0,0,.10);
  background:color-mix(in srgb, var(--card) 70%, var(--bg));
}
.book-cover-fallback{
  height:60px;
  width:42px;
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:4px;
  border:1px dashed var(--border);
  color:var(--muted);
  font-size:11px;
  padding:6px;
  text-align:center;
  line-height:1.1;
  background:color-mix(in srgb, var(--card) 70%, var(--bg));
}
.book-meta{min-width:0;}
.book strong{
  display:block;
  font-size:16px;
  letter-spacing:.2px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.book small{
  color:var(--muted);
  display:block;
  margin-top:2px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

@media (max-width:560px){
  .book{align-items:flex-start;}
  .book strong,.book small{white-space:normal;}
}

/* ===== Reader ===== */
.reader-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

.reader-title{
  font-size:14px;
  color:var(--muted);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:70%;
}

.viewer{
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  background:var(--bg);
  position:relative;
}

.viewer-toolbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:10px;
  border-bottom:1px solid var(--border);
  background:var(--card);
}

.viewer-left,.viewer-right{
  display:flex;
  align-items:center;
  gap:8px;
  min-width: 180px;
}
.viewer-left{justify-content:flex-start; flex-wrap:wrap}
.viewer-right{justify-content:flex-end; flex-wrap:wrap}

.viewer-center{
  display:flex;
  align-items:center;
  gap:10px;
  justify-content:center;
  flex:1;
  flex-wrap:wrap;
}

.viewer-hint{
  color:var(--muted);
  font-size:13px;
  min-width: 180px;
  text-align:center;
}

.pill{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  white-space:nowrap;
}

.save-badge{
  font-size:12px;
  color:var(--muted);
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:color-mix(in srgb, var(--bg) 70%, var(--card));
  opacity:0;
  transform:translateY(2px);
  transition:opacity .18s ease, transform .18s ease;
  white-space:nowrap;
}
.save-badge.show{opacity:1;transform:translateY(0)}

#viewer{
  width:100%;
  height: calc(100vh - 230px);
  background:var(--bg);
}

/* Fullscreen */
.fullscreen-exit{
  position:absolute;
  top:10px;
  right:10px;
  z-index:50;
  display:none;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:color-mix(in srgb, var(--bg) 85%, var(--card));
  color:var(--fg);
  cursor:pointer;
  font-size:14px;
  box-shadow:var(--shadow);
  opacity:0;
  transform:translateY(-2px);
  transition:opacity .18s ease, transform .18s ease;
}
.fullscreen-exit.show{opacity:1;transform:translateY(0)}

.viewer:fullscreen{
  border-radius:0;
  border:0;
  width:100vw;
  height:100vh;
  background:var(--bg);
}
.viewer:fullscreen #viewer{height: calc(100vh - 64px);}
.viewer:fullscreen .fullscreen-exit{
  display:inline-flex;
  align-items:center;
  gap:8px;
}

body.fs header{display:none}
body.fs main{margin:0; padding:0}
body.fs .card{border-radius:0; box-shadow:none; margin:0; padding:0; border:0}
body.fs .reader-top{display:none}

.notice{
  margin-top:10px;
  padding:10px;
  border:1px dashed var(--border);
  border-radius:12px;
  color:var(--muted);
  background:color-mix(in srgb, var(--card) 75%, var(--bg));
}

.footer{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:28px 16px 40px;
}
.footer-logo{max-height:150px;width:auto;display:block}
body.reader-open .footer{display:none}
</style>
</head>

<body>
<header>
  <div class="brand">
    <strong>Biblioteca</strong>
    <span class="tagline">Leitor EPUB ‚Ä¢ Editora CCLA</span>
  </div>
  <button class="btn" id="toggleNight" type="button" aria-label="Alternar tema" title="Alternar tema">üåô Noite</button>
</header>

<main>
  <section id="catalogo" class="card">
    <h2>Cat√°logo</h2>
    <p>Escolha um livro para abrir no leitor.</p>
    <div id="books"></div>
  </section>

  <section id="leitor" class="card" style="display:none;">
    <div class="reader-top">
      <button class="btn" id="backBtn" type="button" title="Voltar ao cat√°logo">‚Üê Cat√°logo</button>
      <div class="reader-title" id="bookTitle">Carregando‚Ä¶</div>
    </div>

    <div class="viewer" id="viewerShell">
      <div class="viewer-toolbar">
        <div class="viewer-left">
          <button class="btn" id="prevBtn" type="button" aria-label="P√°gina anterior" title="P√°gina anterior">‚Üê</button>
          <button class="btn" id="restartBtn" type="button" aria-label="Recome√ßar do in√≠cio" title="Recome√ßar do in√≠cio">Recome√ßar</button>
          <button class="btn" id="fsBtn" type="button" aria-label="Tela cheia" title="Tela cheia">‚õ∂</button>
        </div>

        <div class="viewer-center">
          <button class="btn" id="fontMinus" type="button" aria-label="Diminuir fonte" title="Diminuir fonte">A‚àí</button>
          <div class="viewer-hint" id="progress">‚Äî</div>
          <button class="btn" id="fontPlus" type="button" aria-label="Aumentar fonte" title="Aumentar fonte">A+</button>
        </div>

        <div class="viewer-right">
          <button class="btn" id="justifyBtn" type="button" aria-label="Justifica√ß√£o" title="Alternar justifica√ß√£o">J</button>
          <button class="btn" id="hyphenBtn" type="button" aria-label="Hifeniza√ß√£o" title="Alternar hifeniza√ß√£o">Hy</button>

          <span class="pill" id="timePill" aria-label="Tempo de leitura">Tempo: 00:00</span>
          <span class="save-badge" id="saveBadge" aria-live="polite">√öltima leitura salva ‚úÖ</span>
          <button class="btn" id="nextBtn" type="button" aria-label="Pr√≥xima p√°gina" title="Pr√≥xima p√°gina">‚Üí</button>
        </div>
      </div>

      <button class="fullscreen-exit" id="fsExitBtn" type="button" aria-label="Sair da tela cheia" title="Sair da tela cheia">‚§´ Sair</button>
      <div id="viewer" aria-label="√Årea de leitura"></div>
    </div>

    <div id="errorBox" class="notice" style="display:none;"></div>
  </section>
</main>

<footer class="footer" aria-label="Editora CCLA">
  <img class="footer-logo" src="assets/logo/ccla_editora.png" alt="Editora CCLA">
</footer>

<script src="jszip.min.js"></script>
<script src="epub.min.js"></script>
<script>
(() => {
  "use strict";

  // ====== CONFIG ======
  const BOOKS = [
    { id: "extrativismo", title: "Extrativismo", author: "Anna Bednik e J√©r√©my Dotti", file: "extrativismo.epub", cover: "assets/covers/capa-extrativismo.jpg" },
    { id: "geografia-libertaria", title: "Por uma Geografia libert√°ria", author: "Marcelo Lopes de Souza", file: "mls.epub", cover: "assets/covers/capa-mls.jpg" }
  ];

  // ====== DOM ======
  const elCatalogo = document.getElementById("catalogo");
  const elLeitor = document.getElementById("leitor");
  const elBooks = document.getElementById("books");
  const elTitle = document.getElementById("bookTitle");
  const elProgress = document.getElementById("progress");
  const elError = document.getElementById("errorBox");
  const elSaveBadge = document.getElementById("saveBadge");
  const elTimePill = document.getElementById("timePill");

  const btnNight = document.getElementById("toggleNight");
  const btnBack = document.getElementById("backBtn");
  const btnPrev = document.getElementById("prevBtn");
  const btnNext = document.getElementById("nextBtn");
  const btnRestart = document.getElementById("restartBtn");
  const btnFontMinus = document.getElementById("fontMinus");
  const btnFontPlus  = document.getElementById("fontPlus");
  const btnJustify   = document.getElementById("justifyBtn");
  const btnHyphen    = document.getElementById("hyphenBtn");

  // Fullscreen
  const viewerShell = document.getElementById("viewerShell");
  const btnFs = document.getElementById("fsBtn");
  const btnFsExit = document.getElementById("fsExitBtn");

  // ====== STATE ======
  let book = null;
  let rendition = null;
  let currentItem = null;

  let fontPct = Number(localStorage.getItem("fontPct") || 110);
  let saveBadgeTimer = null;
  let locReadyPromise = Promise.resolve(false);

  let justifyOn = (localStorage.getItem("justifyOn") || "0") === "1";
  let hyphenOn  = (localStorage.getItem("hyphenOn")  || "1") === "1";

  // Mode fix√© : pages (horizontal) uniquement
  const FLOW_MODE = "paginated";

  // Hook lang (par rendition)
  let langHookInstalled = false;

  // ====== TIMER ======
  let readingSeconds = 0;
  let rafId = null;
  let lastTs = null;
  let carryMs = 0;
  const CHUNK_MS = 30000;

  // ====== UTIL ======
  function escapeHtml(value) {
    return String(value ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function showError(message) {
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function showNotice(message){
    elError.style.display = "block";
    elError.innerHTML = escapeHtml(message).replace(/\n/g, "<br>");
  }

  function clearError() {
    elError.style.display = "none";
    elError.textContent = "";
  }

  function showReader() {
    elCatalogo.style.display = "none";
    elLeitor.style.display = "block";
    document.body.classList.add("reader-open");
  }

  function showCatalog() {
    elLeitor.style.display = "none";
    elCatalogo.style.display = "block";
    document.body.classList.remove("reader-open");
  }

  function showSavedBadge() {
    if (!elSaveBadge) return;
    elSaveBadge.classList.add("show");
    if (saveBadgeTimer) clearTimeout(saveBadgeTimer);
    saveBadgeTimer = setTimeout(() => elSaveBadge.classList.remove("show"), 1400);
  }

  // ====== STORAGE KEYS ======
  function storageKeyForBook(item) { return "pos:" + (item && item.id ? item.id : "unknown"); }
  function timeKeyForBook(item)    { return "time:" + (item && item.id ? item.id : "unknown"); }
  function locKeyForBook(item)     { return "loc:" + (item && item.id ? item.id : "unknown"); }

  // ====== POSITION SAVE/LOAD (CFI) ======
  function savePosition(item, location) {
    try {
      const cfi = location && location.start && location.start.cfi;
      if (!cfi) return;
      localStorage.setItem(storageKeyForBook(item), cfi);
      showSavedBadge();
    } catch(e) {}
  }
  function loadPosition(item) {
    try { return localStorage.getItem(storageKeyForBook(item)); }
    catch(e){ return null; }
  }
  function clearPosition(item) {
    try { localStorage.removeItem(storageKeyForBook(item)); }
    catch(e){}
  }

  // ====== LOCATIONS (for % progress) ======
  async function ensureLocations(item){
    if (!book || !book.locations) return false;
    try {
      if (book.ready) await book.ready;
      if (typeof book.locations.length === "function" && book.locations.length() > 0) return true;

      const saved = localStorage.getItem(locKeyForBook(item));
      if (saved) {
        book.locations.load(saved);
        if (book.locations.length() > 0) return true;
      }

      await book.locations.generate(1024);

      try { localStorage.setItem(locKeyForBook(item), book.locations.save()); } catch(e) {}
      return (typeof book.locations.length === "function" && book.locations.length() > 0);
    } catch(e) {
      return false;
    }
  }

  function percentFromLocation(location){
    const displayed = location && location.start && location.start.displayed;

    const p = location && location.start && location.start.percentage;
    if (typeof p === "number" && isFinite(p)) {
      const pp = Math.max(0, Math.min(1, p));
      if (!(displayed && displayed.page && displayed.total && displayed.page < displayed.total && pp > 0.99)) {
        return pp;
      }
    }

    const cfi = location && location.start && location.start.cfi;
    if (!cfi || !book || !book.locations || typeof book.locations.length !== "function") return null;
    if (book.locations.length() === 0) return null;

    if (typeof book.locations.percentageFromCfi === "function") {
      const px = book.locations.percentageFromCfi(cfi);
      if (typeof px === "number" && isFinite(px)) {
        const pp = Math.max(0, Math.min(1, px));
        if (displayed && displayed.page && displayed.total && displayed.page < displayed.total && pp > 0.99) return null;
        return pp;
      }
    }
    return null;
  }

  // ====== TIMER (rAF) ======
  function isReadingActive(){
    return document.body.classList.contains("reader-open")
      && document.visibilityState === "visible"
      && !!currentItem;
  }

  function loadReadingTime(item){
    try {
      const v = Number(localStorage.getItem(timeKeyForBook(item)) || 0);
      return Number.isFinite(v) && v >= 0 ? v : 0;
    } catch(e){ return 0; }
  }

  function saveReadingTime(item){
    try { localStorage.setItem(timeKeyForBook(item), String(readingSeconds)); } catch(e){}
  }

  function formatTime(sec){
    const s = Math.max(0, Math.floor(sec));
    const mm = Math.floor(s / 60);
    const ss = s % 60;
    return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
  }

  function updateTimeUI(){
    if (!elTimePill) return;
    elTimePill.textContent = `Tempo: ${formatTime(readingSeconds)}`;
  }

  function commitChunks(){
    const chunks = Math.floor(carryMs / CHUNK_MS);
    if (chunks > 0) {
      readingSeconds += chunks * 30;
      carryMs -= chunks * CHUNK_MS;
      if (currentItem) saveReadingTime(currentItem);
      updateTimeUI();
    }
  }

  function rafLoop(ts){
    if (lastTs === null) lastTs = ts;
    let dt = ts - lastTs;
    lastTs = ts;

    if (!Number.isFinite(dt) || dt < 0) dt = 0;
    if (dt > 5000) dt = 0;

    if (isReadingActive()) {
      carryMs += dt;
      commitChunks();
    }
    rafId = requestAnimationFrame(rafLoop);
  }

  function startReadingTimer(){
    stopReadingTimer();
    carryMs = 0;
    lastTs = null;
    updateTimeUI();
    rafId = requestAnimationFrame(rafLoop);
  }

  function stopReadingTimer(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    commitChunks();
    carryMs = 0;
    lastTs = null;
  }

  document.addEventListener("visibilitychange", () => {
    lastTs = null;
    updateTimeUI();
  });

  window.addEventListener("pagehide", () => {
    if (currentItem) saveReadingTime(currentItem);
  });

  // ====== READING PREFS ======
  function applyReadingPrefs() {
    if (!rendition) return;
    try {
      rendition.themes.fontSize(fontPct + "%");
      localStorage.setItem("fontPct", String(fontPct));
    } catch(e) {}
  }

  function syncJustifyHyphenButtons(){
    if (btnJustify) btnJustify.textContent = justifyOn ? "J‚úì" : "J";
    if (btnHyphen)  btnHyphen.textContent  = hyphenOn  ? "Hy‚úì" : "Hy";
  }

  // ====== THEME + TEXT LAYOUT (justify/hyphen) ======
  function ensureLangHook(){
    if (!rendition || langHookInstalled) return;
    langHookInstalled = true;

    try {
      rendition.hooks.content.register((contents) => {
        try {
          const doc = contents.document;
          if (!doc) return;
          if (!doc.documentElement.getAttribute("lang")) doc.documentElement.setAttribute("lang","pt-BR");
          if (doc.body && !doc.body.getAttribute("lang")) doc.body.setAttribute("lang","pt-BR");
        } catch(e) {}
      });
    } catch(e) {}
  }

  function applyThemeToRendition() {
    if (!rendition) return;

    ensureLangHook();

    const night = document.body.classList.contains("night");
    const align = justifyOn ? "justify" : "start";
    const hy = hyphenOn ? "auto" : "manual";

    rendition.themes.register("app", {
      "body": {
        "background": night ? "#0f1115" : "#ffffff",
        "color": night ? "#e9edf1" : "#111111",
        "line-height": "1.65",
        "text-rendering": "optimizeLegibility"
      },
      "p,li,blockquote,div,section,article": {
        "line-height": "1.65",
        "text-align": align,
        "hyphens": hy,
        "-webkit-hyphens": hy,
        "-ms-hyphens": hy
      },
      "a": { "color": night ? "#8ab4f8" : "#0b57d0" }
    });

    rendition.themes.select("app");

    try {
      rendition.themes.override("body", "padding", "18px 18px 24px 18px");
      rendition.themes.override("body", "margin", "0");
      rendition.themes.override("html", "margin", "0");
    } catch(e) {}

    applyReadingPrefs();
    syncJustifyHyphenButtons();

    try { localStorage.setItem("justifyOn", justifyOn ? "1" : "0"); } catch(e) {}
    try { localStorage.setItem("hyphenOn",  hyphenOn  ? "1" : "0"); } catch(e) {}
  }

  function setTheme(isNight) {
    document.body.classList.toggle("night", isNight);
    localStorage.setItem("theme", isNight ? "night" : "day");
    btnNight.textContent = isNight ? "‚òÄÔ∏è Dia" : "üåô Noite";
    btnNight.setAttribute("aria-label", isNight ? "Ativar modo dia" : "Ativar modo noite");
    applyThemeToRendition();
  }

  function initTheme() {
    const saved = localStorage.getItem("theme");
    setTheme(saved === "night");
    btnNight.addEventListener("click", () => setTheme(!document.body.classList.contains("night")));
  }

  // ===== FULLSCREEN =====
  function isFullscreen(){ return !!document.fullscreenElement; }

  function showFsExitTemporarily(){
    if (!btnFsExit) return;
    btnFsExit.classList.add("show");
    clearTimeout(showFsExitTemporarily._t);
    showFsExitTemporarily._t = setTimeout(() => btnFsExit.classList.remove("show"), 1800);
  }

  async function enterFullscreen(){
    if (!viewerShell) return;
    if (!document.fullscreenEnabled) return;
    try{ await viewerShell.requestFullscreen(); } catch(e){}
  }

  async function exitFullscreen(){
    try{ if (document.fullscreenElement) await document.exitFullscreen(); } catch(e){}
  }

  function toggleFullscreen(){
    if (isFullscreen()) exitFullscreen();
    else enterFullscreen();
  }

  document.addEventListener("fullscreenchange", () => {
    const fs = isFullscreen();
    document.body.classList.toggle("fs", fs);
    if (btnFs) btnFs.textContent = fs ? "‚§´" : "‚õ∂";
    if (fs) showFsExitTemporarily();
    else if (btnFsExit) btnFsExit.classList.remove("show");
    try { rendition && rendition.resize(); } catch(e){}
  });

  ["mousemove","touchstart","click"].forEach(evt => {
    viewerShell && viewerShell.addEventListener(evt, () => {
      if (isFullscreen()) showFsExitTemporarily();
    }, {passive:true});
  });

  // ====== UI ======
  function coverHtml(b){
    if (!b.cover) {
      return `<div class="book-cover-fallback" aria-hidden="true">sem<br>capa</div>`;
    }
    return `
      <img
        class="book-cover"
        src="${escapeHtml(b.cover)}"
        alt="Capa ‚Äì ${escapeHtml(b.title)}"
        loading="lazy"
        onerror="this.outerHTML='<div class=&quot;book-cover-fallback&quot; aria-hidden=&quot;true&quot;>sem<br>capa</div>'"
      >
    `;
  }

  function renderCatalog() {
    if (!elBooks) return;

    if (!Array.isArray(BOOKS) || BOOKS.length === 0) {
      elBooks.innerHTML = `
        <div class="notice">
          Nenhum livro configurado.<br>
          Adicione arquivos <code>.epub</code> em <code>epubs/</code> e atualize a lista no c√≥digo.
        </div>
      `;
      return;
    }

    elBooks.innerHTML = BOOKS.map(b => `
      <div class="book">
        <div class="book-left">
          ${coverHtml(b)}
          <div class="book-meta">
            <strong>${escapeHtml(b.title)}</strong>
            <small>${escapeHtml(b.author || "")}</small>
          </div>
        </div>
        <button class="btn btn-primary" type="button" data-book="${escapeHtml(b.id)}">Ler</button>
      </div>
    `).join("");

    elBooks.querySelectorAll("button[data-book]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-book");
        const item = BOOKS.find(x => x.id === id);
        if (item) openBook(item);
      });
    });
  }

  function updateProgressUI(location){
    const displayed = location && location.start && location.start.displayed;
    const percent = percentFromLocation(location);

    const pagePart = (displayed && displayed.page && displayed.total)
      ? `P√°gina ${displayed.page} / ${displayed.total}`
      : "‚Äî";

    const pctPart = (percent !== null)
      ? ` ‚Ä¢ ${Math.round(percent * 100)}%`
      : "";

    elProgress.textContent = pagePart + pctPart;
  }

  // ====== REPRISE (TOC / SPINE) ======
  async function displayFromTOCOrSpine(){
    // 1) TOC (nav)
    try {
      if (book && book.navigation && Array.isArray(book.navigation.toc) && book.navigation.toc.length) {
        const toc = book.navigation.toc;
        const first = toc.find(t => t && t.href) || null;
        if (first && first.href) {
          await rendition.display(first.href);
          return true;
        }
      }
    } catch(e) {}

    // 2) spine: premier item linear "yes"
    try {
      const items = book && book.spine && book.spine.items ? book.spine.items : null;
      if (items && items.length) {
        for (const it of items) {
          const linear = String(it.linear || "yes").toLowerCase();
          if (linear === "no") continue;
          const href = it.href || "";
          if (!href) continue;
          try {
            await rendition.display(href);
            return true;
          } catch(e){}
        }
      }
    } catch(e) {}

    // 3) fallback epub.js
    try { await rendition.display(); return true; } catch(e) {}
    return false;
  }

  async function applyFlowPaginated(keepLocation = true){
    if (!rendition) return;

    let cfi = null;
    if (keepLocation) {
      try {
        const loc = rendition.currentLocation && rendition.currentLocation();
        cfi = loc && loc.start && loc.start.cfi ? loc.start.cfi : null;
      } catch(e){}
    }

    try { rendition.spread("none"); } catch(e){}
    try { rendition.flow(FLOW_MODE); } catch(e){}

    try { if (cfi) await rendition.display(cfi); } catch(e){}
    try { rendition.resize(); } catch(e){}
  }

  // ====== EPUB ======
  async function openBook(item) {
    clearError();

    currentItem = item;
    readingSeconds = loadReadingTime(item);
    updateTimeUI();

    showReader();
    elTitle.textContent = item.title || "Livro";

    const savedCfi = loadPosition(item);
    elProgress.textContent = savedCfi ? "Retomando‚Ä¶" : "Carregando‚Ä¶";
    if (elSaveBadge) elSaveBadge.classList.remove("show");

    startReadingTimer();

    if (typeof window.ePub !== "function") {
      showError(
        "N√£o consegui carregar o epub.js.\n" +
        "Verifique se existe o arquivo: epub.min.js\n" +
        "na mesma pasta do arquivo HTML."
      );
      elProgress.textContent = "‚Äî";
      return;
    }

    try {
      if (rendition) {
        try { rendition.destroy(); } catch(e) {}
        rendition = null;
      }
      book = null;

      // reset par ouverture
      langHookInstalled = false;

      const path = "epubs/" + item.file;

      const resp = await fetch(path);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const arrayBuffer = await resp.arrayBuffer();

      book = window.ePub(arrayBuffer);

      locReadyPromise = (book.ready ? book.ready.then(() => ensureLocations(item)) : ensureLocations(item));

      rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        spread: "none"
      });

      // mode paginated uniquement
      await applyFlowPaginated(false);

      btnPrev.onclick = () => rendition && rendition.prev();
      btnNext.onclick = () => rendition && rendition.next();

      btnRestart.onclick = async () => {
        if (!currentItem || !rendition) return;
        clearPosition(currentItem);
        elProgress.textContent = "Carregando‚Ä¶";
        try { await displayFromTOCOrSpine(); } catch(e){}
        applyThemeToRendition();
        await applyFlowPaginated(true);
      };

      btnFontMinus.onclick = () => {
        fontPct = Math.max(80, fontPct - 10);
        applyReadingPrefs();
      };
      btnFontPlus.onclick = () => {
        fontPct = Math.min(200, fontPct + 10);
        applyReadingPrefs();
      };

      btnJustify.onclick = () => {
        justifyOn = !justifyOn;
        applyThemeToRendition();
      };

      btnHyphen.onclick = () => {
        hyphenOn = !hyphenOn;
        applyThemeToRendition();
      };

      if (btnFs) btnFs.onclick = toggleFullscreen;
      if (btnFsExit) btnFsExit.onclick = exitFullscreen;

      rendition.on("relocated", (location) => {
        savePosition(item, location);
        updateProgressUI(location);
      });

      rendition.on("rendered", () => applyThemeToRendition());

      // ===== Reprise robuste =====
      if (savedCfi) {
        try {
          await rendition.display(savedCfi);
        } catch(e) {
          clearPosition(item);
          showNotice("‚ÑπÔ∏è Posi√ß√£o salva incompat√≠vel com a nova vers√£o do EPUB. Abrindo no in√≠cio‚Ä¶");
          await displayFromTOCOrSpine();
        }
      } else {
        const ok = await displayFromTOCOrSpine();
        if (!ok) {
          try { await rendition.display(); } catch(e){}
        }
      }

      // Applique th√®me + recale flow
      applyThemeToRendition();
      syncJustifyHyphenButtons();
      await applyFlowPaginated(true);

      // Ensure locations ready then force a first % update
      try {
        await locReadyPromise;
        const loc = rendition && rendition.currentLocation ? rendition.currentLocation() : null;
        if (loc) updateProgressUI(loc);
      } catch(e) {}

    } catch (err) {
      console.error(err);
      showError(
        "Falha ao abrir o EPUB.\n" +
        "Detalhe t√©cnico: " + (err && err.message ? err.message : String(err))
      );
      elProgress.textContent = "‚Äî";
    }
  }

  btnBack.addEventListener("click", async () => {
    clearError();
    stopReadingTimer();
    if (isFullscreen()) await exitFullscreen();
    showCatalog();
  });

  // navigation clavier (pages)
  document.addEventListener("keydown", (e) => {
    if (!rendition) return;
    if (e.key === "ArrowLeft") { e.preventDefault(); try{ rendition.prev(); } catch(_e){} }
    if (e.key === "ArrowRight"){ e.preventDefault(); try{ rendition.next(); } catch(_e){} }
  });

  initTheme();
  syncJustifyHyphenButtons();
  renderCatalog();
})();
</script>

</body>
</html>
